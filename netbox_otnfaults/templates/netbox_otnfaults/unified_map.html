{% extends 'base/layout.html' %}
{% load static %}
{% block title %}{{ mode_config.title }}{% if header_info %} - {{ header_info }}{% endif %}{% endblock %}

{% block content %}
<div class="row mb-3">
  <div class="col">
    <div class="card">
      <h5 class="card-header">
        {{ mode_config.title }} {% if header_info %}
        <span class="text-muted ms-2">- {{ header_info }}</span>
        {% endif %} {% if mode_config.header_actions or return_url %}
        <div class="card-actions">
          {% if return_url %}
          <a href="{{ return_url }}" class="btn btn-ghost-primary btn-sm me-2">
            <i class="mdi mdi-arrow-left"></i> {{ return_label|default:"返回详情" }}
          </a>
          {% endif %}
          
          {% for action in mode_config.header_actions %}
          <a href="{{ action.url }}" class="btn btn-ghost-primary btn-sm">
            <i class="mdi {{ action.icon }}"></i> {{ action.label }}
          </a>
          {% endfor %}
        </div>
        {% endif %}
      </h5>
      <div class="card-body p-0">
        <div id="map" style="height: calc(-178px + 100vh); width: 100%"></div>
      </div>
    </div>
  </div>
</div>

<!-- MapLibre GL JS -->
<link
  href="{% static 'netbox_otnfaults/lib/maplibre-gl.css' %}"
  rel="stylesheet"
/>
<script src="{% static 'netbox_otnfaults/lib/maplibre-gl.js' %}"></script>
<script src="{% static 'netbox_otnfaults/lib/pmtiles.js' %}"></script>
<script src="{% static 'netbox_otnfaults/lib/deck-gl.min.js' %}"></script>
<script src="{% static 'netbox_otnfaults/lib/maplibre-gl-measures.js' %}"></script>

<!-- 样式 -->
<link
  rel="stylesheet"
  href="{% static 'netbox_otnfaults/css/otnfault_map_globe.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'netbox_otnfaults/css/otnfault_map_controls.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'netbox_otnfaults/css/fault_popup_animations.css' %}"
/>
{% if map_mode == 'route_editor' %}
<link
  rel="stylesheet"
  href="{% static 'netbox_otnfaults/css/route_editor.css' %}"
/>
{% endif %}

<style>
  .maplibregl-popup-close-button:focus {
    outline: none;
    box-shadow: none;
  }
</style>

<!-- 性能监控初始化 -->
<script>
  window.OTNPerf = {
    marks: {},
    init: function() {
      this.marks['page_start'] = performance.now();
    },
    mark: function(name) {
      this.marks[name] = performance.now();
      if (window.OTN_DEBUG_MODE) {
        console.log(`[OTNPerf] ${name}: ${this.marks[name].toFixed(2)}ms`);
      }
    },
    getDuration: function(start, end) {
      if (this.marks[start] && this.marks[end]) {
        return (this.marks[end] - this.marks[start]).toFixed(2);
      }
      return '-';
    },
    getNavigationTiming: function() {
      const nav = performance.getEntriesByType("navigation")[0];
      if (!nav) return null;
      return {
        ttfb: (nav.responseStart - nav.requestStart).toFixed(2),
        download: (nav.responseEnd - nav.responseStart).toFixed(2),
        dom_processing: (nav.domInteractive - nav.responseEnd).toFixed(2),
        total_network: (nav.responseEnd - nav.startTime).toFixed(2)
      };
    }
  };
  window.OTNPerf.init();
</script>

<!-- 配置注入 -->
<script>
  window.OTN_DEBUG_MODE = {{ debug_mode|yesno:"true,false" }};
  window.OTN_SHOW_DEBUG_PANEL = {{ show_debug_panel|yesno:"true,false" }} || (new URLSearchParams(window.location.search).has('debug'));
  window.OTN_DEBUG_DATE = '{{ debug_date }}';

  window.OTNMapConfig = {
    mode: '{{ map_mode }}',
    apiKey: '{{ apikey }}',
    mapCenter: {{ map_center|safe }},
    mapZoom: {{ map_zoom }},
    useLocalBasemap: {{ use_local_basemap|yesno:'true,false' }},
    localTilesUrl: '{{ local_tiles_url }}',
    localGlyphsUrl: '{{ local_glyphs_url }}',
    otnPathsPmtilesUrl: '{{ otn_paths_pmtiles_url }}',
    layers: {{ layers_config|safe }},
    projection: '{{ projection }}',
    mapDataUrl: '{{ map_data_url }}',
    {% if colors_config %}colorsConfig: {{ colors_config|safe }},{% endif %}
    {% if fault_list_url %}faultListUrl: '{{ fault_list_url }}',{% endif %}
    {% if target_lat %}targetLat: {{ target_lat }},{% endif %}
    {% if target_lng %}targetLng: {{ target_lng }},{% endif %}
    {% if highlight_path_data %}highlightPathData: {{ highlight_path_data|safe }},{% endif %}
    {% if highlight_sites_data %}highlightSitesData: {{ highlight_sites_data|safe }},{% endif %}
    {% if path_name %}pathName: '{{ path_name }}',{% endif %}
    {% if path_group_id %}pathGroupId: {{ path_group_id }},{% endif %}
    {% if path_group_name %}pathGroupName: '{{ path_group_name }}',{% endif %}
  };

  
  // 自动补全相对路径为绝对路径 (支持 PMTiles 等协议解析)
  (function() {
    const resolveUrl = (url) => {
      if (url && url.startsWith('/')) {
        // 获取当前协议和主机名，并强制拼接 :8080 端口
        // 例如: http://192.168.30.177:8000 -> http://192.168.30.177:8080
        return `${window.location.protocol}//${window.location.hostname}:8080${url}`;
      }
      return url;
    };
    
    const config = window.OTNMapConfig;
    config.localTilesUrl = resolveUrl(config.localTilesUrl);
    config.localGlyphsUrl = resolveUrl(config.localGlyphsUrl);
    config.otnPathsPmtilesUrl = resolveUrl(config.otnPathsPmtilesUrl);
  })();

  // 兼容旧版代码 (LayerToggleControl, FaultStatisticsControl 等)
  window.OTNFaultMapConfig = window.OTNMapConfig;
</script>

<!-- 基础 JS -->
<script src="{% static 'netbox_otnfaults/js/maplibregl_base.js' %}"></script>
<script src="{% static 'netbox_otnfaults/js/services/PopupTemplates.js' %}"></script>

<!-- 模式特定 JS -->
{% for js_file in mode_config.js_files %}
<script src="{% static 'netbox_otnfaults/js/' %}{{ js_file }}"></script>
{% endfor %}

<!-- 核心 + 模式插件 -->
<script src="{% static 'netbox_otnfaults/js/unified_map_core.js' %}"></script>
<script src="{% static 'netbox_otnfaults/js/modes/' %}{{ mode_config.plugin_file }}"></script>

{% endblock %}
