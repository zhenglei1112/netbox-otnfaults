{% extends 'base/layout.html' %}
{% load static %}

{% block title %}æ•…éšœåˆ†å¸ƒå›¾{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <div class="card">
            <h5 class="card-header">
                æ•…éšœåˆ†å¸ƒå›¾
                <div class="card-actions">
                    <a href="{% url 'plugins:netbox_otnfaults:otnfault_list' %}" class="btn btn-ghost-primary btn-sm">
                        <i class="mdi mdi-format-list-bulleted"></i> æŸ¥çœ‹åˆ—è¡¨
                    </a>
                </div>
            </h5>
            <div class="card-body p-0">
                <div id="map" style="height:calc(-178px + 100vh);width: 100%;"></div>
            </div>
        </div>
    </div>
</div>

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<style>
    #map {
        position: relative;
        height: 600px;
        width: 100%;
    }
    .map-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .map-loading {
        background-color: rgba(248, 249, 250, 0.9);
        color: #6c757d;
    }
    .map-error {
        background-color: rgba(248, 215, 218, 0.95);
        color: #721c24;
        padding: 20px;
        text-align: center;
    }
    .map-error h5 {
        margin-bottom: 15px;
    }
    .map-error ul {
        text-align: left;
        margin: 15px 0;
    }
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    .hidden {
        display: none !important;
    }
    /* éšè—åœ°å›¾ç‰ˆæƒä¿¡æ¯ */
    .maplibregl-ctrl-attrib {
        display: none !important;
    }
    /* å›¾å±‚åˆ‡æ¢æŒ‰é’®æ ·å¼ */
    .layer-toggle-control .toggle-button {
        background-color: #ffffff;
        border: 1px solid #cccccc;
        border-radius: 4px;
        width: 32px;
        height: 32px;
        margin: 2px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.2s ease;
    }
    .layer-toggle-control .toggle-button:hover {
        background-color: #f0f0f0;
    }
    .layer-toggle-control .toggle-button.active {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
    }
    .layer-toggle-control .toggle-button.active:hover {
        background-color: #0056b3;
    }
    .layer-toggle-control .heatmap-toggle.active {
        background-color: #ff6b6b;
        border-color: #ff4757;
    }
    .layer-toggle-control .heatmap-toggle.active:hover {
        background-color: #ff4757;
    }
    .layer-toggle-control .markers-toggle.active {
        background-color: #4cd964;
        border-color: #2ecc71;
    }
    .layer-toggle-control .markers-toggle.active:hover {
        background-color: #2ecc71;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var mapContainer = document.getElementById('map');
        
        // åˆ›å»ºåŠ è½½è¦†ç›–å±‚
        var loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'map-overlay map-loading';
        loadingOverlay.innerHTML = `
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <div class="mt-3">æ­£åœ¨åŠ è½½åœ°å›¾...</div>
        `;
        mapContainer.appendChild(loadingOverlay);
        
        try {
            // éªŒè¯æ•°æ®æ ¼å¼
            var heatmapData = {{ heatmap_data|safe }};
            var markerData = {{ marker_data|safe }};
            var apiKey = "{{ apikey }}";
            
            // æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰æ•ˆ
            if (!Array.isArray(heatmapData)) {
                console.warn('heatmap_data ä¸æ˜¯æœ‰æ•ˆçš„æ•°ç»„ï¼Œä½¿ç”¨ç©ºæ•°ç»„');
                heatmapData = [];
            }
            if (!Array.isArray(markerData)) {
                console.warn('marker_data ä¸æ˜¯æœ‰æ•ˆçš„æ•°ç»„ï¼Œä½¿ç”¨ç©ºæ•°ç»„');
                markerData = [];
            }

            // æ£€æŸ¥ Maplibre GL æ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof maplibregl === 'undefined') {
                throw new Error('åœ°å›¾åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢');
            }

            var map = new maplibregl.Map({
                container: 'map',
                style: 'https://tiles.stadiamaps.com/styles/alidade_satellite.json?api_key=' + apiKey,
                center: [105.0, 35.0], // é»˜è®¤ä¸­å¿ƒç‚¹ï¼ˆä¸­å›½ï¼‰
                zoom: 4
            });

            map.addControl(new maplibregl.NavigationControl());
            
            // æ·»åŠ å…¨å±æ§ä»¶
            map.addControl(new maplibregl.FullscreenControl({
                container: document.querySelector('#map')
            }));

            // åˆ›å»ºå›¾å±‚åˆ‡æ¢æ§ä»¶
            class LayerToggleControl {
                constructor(options) {
                    this.options = options || {};
                    this.heatmapVisible = true;
                    this.markersVisible = true;
                    this.markers = []; // å­˜å‚¨æ ‡è®°å¯¹è±¡
                }
                
                onAdd(map) {
                    this.map = map;
                    this.container = document.createElement('div');
                    this.container.className = 'maplibregl-ctrl maplibregl-ctrl-group layer-toggle-control';
                    
                    // çƒ­åŠ›å›¾å¼€å…³æŒ‰é’®
                    this.heatmapButton = document.createElement('button');
                    this.heatmapButton.className = 'maplibregl-ctrl-icon toggle-button heatmap-toggle active';
                    this.heatmapButton.innerHTML = 'ğŸ”¥';
                    this.heatmapButton.title = 'çƒ­åŠ›å›¾å¼€å…³';
                    this.heatmapButton.onclick = () => this.toggleHeatmap();
                    
                    // æ•…éšœç‚¹å¼€å…³æŒ‰é’®
                    this.markersButton = document.createElement('button');
                    this.markersButton.className = 'maplibregl-ctrl-icon toggle-button markers-toggle active';
                    this.markersButton.innerHTML = 'ğŸ“';
                    this.markersButton.title = 'æ•…éšœç‚¹å¼€å…³';
                    this.markersButton.onclick = () => this.toggleMarkers();
                    
                    this.container.appendChild(this.heatmapButton);
                    this.container.appendChild(this.markersButton);
                    
                    return this.container;
                }
                
                onRemove() {
                    this.container.parentNode.removeChild(this.container);
                    this.map = undefined;
                }
                
                toggleHeatmap() {
                    this.heatmapVisible = !this.heatmapVisible;
                    if (this.heatmapVisible) {
                        this.heatmapButton.classList.add('active');
                        this.map.setLayoutProperty('faults-heat', 'visibility', 'visible');
                    } else {
                        this.heatmapButton.classList.remove('active');
                        this.map.setLayoutProperty('faults-heat', 'visibility', 'none');
                    }
                }
                
                toggleMarkers() {
                    this.markersVisible = !this.markersVisible;
                    if (this.markersVisible) {
                        this.markersButton.classList.add('active');
                        // æ˜¾ç¤ºæ‰€æœ‰æ ‡è®°
                        this.markers.forEach(marker => marker.getElement().style.display = 'block');
                    } else {
                        this.markersButton.classList.remove('active');
                        // éšè—æ‰€æœ‰æ ‡è®°
                        this.markers.forEach(marker => marker.getElement().style.display = 'none');
                    }
                }
                
                addMarker(marker) {
                    this.markers.push(marker);
                }
            }
            
            // æ·»åŠ å›¾å±‚åˆ‡æ¢æ§ä»¶
            var layerToggleControl = new LayerToggleControl();
            map.addControl(layerToggleControl, 'top-left');

            // åœ¨æ ·å¼åŠ è½½æ—¶ç«‹å³è®¾ç½®ä¸­æ–‡æ ‡ç­¾
            map.on('style.load', function () {
                // è®¾ç½®åœ°å›¾è¯­è¨€ä¸ºä¸­æ–‡
                function setMapLanguageToChinese() {
                    const layers = map.getStyle().layers;
                    layers.forEach(layer => {
                        if (layer.layout && layer.layout['text-field']) {
                            map.setLayoutProperty(layer.id, 'text-field', ['coalesce', ['get', 'name:zh'], ['get', 'name']]);
                        }
                    });
                }
                
                // è¿‡æ»¤åŸå¸‚æ ‡ç­¾ - åªæ˜¾ç¤ºä¸»è¦åŸå¸‚
                function filterCityLabels() {
                    const layers = map.getStyle().layers;
                    layers.forEach(layer => {
                        if (layer.type === 'symbol' &&
                            (layer.id.includes('place') || layer.id.includes('settlement') ||
                             layer.id.includes('label'))) {
                            if (layer.id.includes('village') || layer.id.includes('town') ||
                                layer.id.includes('hamlet') || layer.id.includes('suburb') ||
                                layer.id.includes('neighbourhood') || layer.id.includes('neighborhood') ||
                                layer.id.includes('quarter') || layer.id.includes('locality') ||
                                layer.id.includes('isolated_dwelling')) {
                                map.setLayoutProperty(layer.id, 'visibility', 'none');
                            }
                        }
                    });
                }
                
                // ç«‹å³è°ƒç”¨ä¸­æ–‡æ ‡ç­¾è®¾ç½®å‡½æ•°
                setMapLanguageToChinese();
                // è¿‡æ»¤åŸå¸‚æ ‡ç­¾ï¼Œåªæ˜¾ç¤ºä¸»è¦åŸå¸‚
                filterCityLabels();
            });

            map.on('load', function () {
                // å‡†å¤‡çƒ­åŠ›å›¾çš„GeoJSONæ•°æ®
                var features = heatmapData.map(function (point) {
                    return {
                        type: 'Feature',
                        properties: { count: point.count },
                        geometry: {
                            type: 'Point',
                            coordinates: [point.lng, point.lat]
                        }
                    };
                });

                if (features.length > 0) {
                    map.addSource('faults', {
                        type: 'geojson',
                        data: {
                            type: 'FeatureCollection',
                            features: features
                        }
                    });

                    map.addLayer({
                        id: 'faults-heat',
                        type: 'heatmap',
                        source: 'faults',
                        maxzoom: 15,
                        paint: {
                            // æ ¹æ®é¢‘ç‡å’Œå±æ€§å¤§å°å¢åŠ çƒ­åŠ›å›¾æƒé‡ - é™ä½é˜ˆå€¼ä½¿çƒ­ç‚¹æ›´æ˜æ˜¾
                            'heatmap-weight': [
                                'interpolate',
                                ['linear'],
                                ['get', 'count'],
                                0, 0,
                                4, 1  // å°†é˜ˆå€¼ä»10é™ä½åˆ°4ï¼Œå¢åŠ ä½å¯†åº¦åŒºåŸŸæ˜¾ç¤º
                            ],
                            // æ ¹æ®ç¼©æ”¾çº§åˆ«å¢åŠ çƒ­åŠ›å›¾é¢œè‰²æƒé‡ - é€‚åº¦å¢å¼ºå¯¹æ¯”åº¦
                            // heatmap-intensityæ˜¯heatmap-weightçš„ä¹˜æ•°
                            'heatmap-intensity': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                0, 1,
                                9, 4  // å°†å¼ºåº¦ä»5è°ƒæ•´åˆ°4ï¼Œé€‚åº¦å¢å¼ºå¯¹æ¯”åº¦
                            ],
                            // çƒ­åŠ›å›¾é¢œè‰²æ¸å˜ã€‚åŸŸä¸º0ï¼ˆä½ï¼‰åˆ°1ï¼ˆé«˜ï¼‰ã€‚
                            // ä»0-stopå¼€å§‹ä½¿ç”¨0é€æ˜åº¦çš„é¢œè‰²åˆ›å»ºæ¨¡ç³Šæ•ˆæœã€‚
                            'heatmap-color': [
                                'interpolate',
                                ['linear'],
                                ['heatmap-density'],
                                0, 'rgba(33,102,172,0)',
                                0.1, 'rgb(103,169,207)',  // æ¢å¤ä½å¯†åº¦åŒºåŸŸçš„é¢œè‰²
                                0.3, 'rgb(209,229,240)',
                                0.5, 'rgb(253,219,199)',
                                0.7, 'rgb(239,138,98)',
                                1, 'rgb(178,24,43)'  // æ¢å¤æ ‡å‡†é«˜å¯†åº¦é¢œè‰²
                            ],
                            // æ ¹æ®ç¼©æ”¾çº§åˆ«è°ƒæ•´çƒ­åŠ›å›¾åŠå¾„ - å¢åŠ åŠå¾„ä½¿çƒ­ç‚¹æ›´æ˜æ˜¾
                            'heatmap-radius': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                0, 3,   // å°†æœ€å°åŠå¾„ä»1å¢åŠ åˆ°3
                                9, 25   // å°†æœ€å¤§åŠå¾„ä»10å¢åŠ åˆ°25ï¼Œä½¿çƒ­ç‚¹æ›´æ˜æ˜¾
                            ],
                            // æ ¹æ®ç¼©æ”¾çº§åˆ«ä»çƒ­åŠ›å›¾è¿‡æ¸¡åˆ°åœ†å½¢å›¾å±‚
                            'heatmap-opacity': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                7, 1,
                                9, 0
                            ],
                        }
                    });

                    // å°†åœ°å›¾è¾¹ç•Œé€‚é…åˆ°æ•°æ®èŒƒå›´
                    var bounds = new maplibregl.LngLatBounds();
                    features.forEach(function (feature) {
                        bounds.extend(feature.geometry.coordinates);
                    });
                    // åŒæ—¶å°†æ ‡è®°ç‚¹åŒ…å«åœ¨è¾¹ç•Œå†…
                    markerData.forEach(function (m) {
                        bounds.extend([m.lng, m.lat]);
                    });

                    if (!bounds.isEmpty()) {
                        map.fitBounds(bounds, { padding: 50 });
                    }
                }

                // æ•…éšœåˆ†ç±»é¢œè‰²æ˜ å°„
                var faultCategoryColors = {
                    'network': '#FF0000',      // ç½‘ç»œæ•…éšœ - çº¢è‰²
                    'equipment': '#FFA500',    // è®¾å¤‡æ•…éšœ - æ©™è‰²
                    'power': '#FFFF00',        // ç”µæºæ•…éšœ - é»„è‰²
                    'optical': '#00FF00',      // å…‰ç¼†æ•…éšœ - ç»¿è‰²
                    'software': '#0000FF',     // è½¯ä»¶æ•…éšœ - è“è‰²
                    'other': '#800080'         // å…¶ä»–æ•…éšœ - ç´«è‰²
                };
                
                // æ•…éšœåˆ†ç±»åç§°æ˜ å°„
                var faultCategoryNames = {
                    'network': 'ç½‘ç»œæ•…éšœ',
                    'equipment': 'è®¾å¤‡æ•…éšœ',
                    'power': 'ç”µæºæ•…éšœ',
                    'optical': 'å…‰ç¼†æ•…éšœ',
                    'software': 'è½¯ä»¶æ•…éšœ',
                    'other': 'å…¶ä»–æ•…éšœ'
                };
                
                // æ·»åŠ æœ€è¿‘ä¸€å‘¨æ•…éšœç‚¹çš„æ ‡è®° - æ ¹æ®æ•…éšœåˆ†ç±»æ˜¾ç¤ºä¸åŒé¢œè‰²
                markerData.forEach(function (m) {
                    // è·å–æ•…éšœåˆ†ç±»ï¼Œé»˜è®¤ä¸º'other'
                    var category = m.category || 'other';
                    var color = faultCategoryColors[category] || faultCategoryColors['other'];
                    var categoryName = faultCategoryNames[category] || faultCategoryNames['other'];
                    
                    var popup = new maplibregl.Popup({ offset: 25 }).setHTML(
                        '<div style="text-align: center;">' +
                        '<h6><a href="' + m.url + '" target="_blank">' + m.number + '</a></h6>' +
                        '<p><strong>æ•…éšœåˆ†ç±»:</strong> ' + categoryName + '</p>' +
                        '<p>' + m.details + '</p>' +
                        '</div>'
                    );

                    var marker = new maplibregl.Marker({ color: color })
                        .setLngLat([m.lng, m.lat])
                        .setPopup(popup)
                        .addTo(map);
                    
                    // å°†æ ‡è®°æ·»åŠ åˆ°åˆ‡æ¢æ§ä»¶ä¸­
                    layerToggleControl.addMarker(marker);
                });
                
                // åˆ›å»ºæ•…éšœç‚¹å›¾ä¾‹
                function createFaultLegend() {
                    var legendContainer = document.createElement('div');
                    legendContainer.className = 'maplibregl-ctrl maplibregl-ctrl-group fault-legend';
                    legendContainer.style.padding = '10px';
                    legendContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
                    legendContainer.style.borderRadius = '4px';
                    legendContainer.style.boxShadow = '0 0 10px rgba(0,0,0,0.1)';
                    legendContainer.style.maxWidth = '200px';
                    
                    var legendTitle = document.createElement('div');
                    legendTitle.innerHTML = '<strong>æ•…éšœåˆ†ç±»å›¾ä¾‹</strong>';
                    legendTitle.style.marginBottom = '8px';
                    legendTitle.style.borderBottom = '1px solid #ddd';
                    legendTitle.style.paddingBottom = '5px';
                    legendContainer.appendChild(legendTitle);
                    
                    // æ·»åŠ æ¯ä¸ªåˆ†ç±»çš„å›¾ä¾‹é¡¹
                    Object.keys(faultCategoryColors).forEach(function(category) {
                        var legendItem = document.createElement('div');
                        legendItem.style.display = 'flex';
                        legendItem.style.alignItems = 'center';
                        legendItem.style.marginBottom = '5px';
                        
                        var colorBox = document.createElement('div');
                        colorBox.style.width = '15px';
                        colorBox.style.height = '15px';
                        colorBox.style.backgroundColor = faultCategoryColors[category];
                        colorBox.style.borderRadius = '3px';
                        colorBox.style.marginRight = '8px';
                        colorBox.style.border = '1px solid #ccc';
                        
                        var label = document.createElement('span');
                        label.style.fontSize = '12px';
                        label.textContent = faultCategoryNames[category];
                        
                        legendItem.appendChild(colorBox);
                        legendItem.appendChild(label);
                        legendContainer.appendChild(legendItem);
                    });
                    
                    return legendContainer;
                }
                
                // æ·»åŠ å›¾ä¾‹åˆ°åœ°å›¾å³ä¸‹è§’
                var legendControl = {
                    onAdd: function(map) {
                        this.container = createFaultLegend();
                        return this.container;
                    },
                    onRemove: function() {
                        this.container.parentNode.removeChild(this.container);
                        this.map = undefined;
                    }
                };
                
                map.addControl(legendControl, 'bottom-right');
                
                // éšè—åŠ è½½çŠ¶æ€
                loadingOverlay.classList.add('hidden');
            });

            map.on('error', function (e) {
                console.error('åœ°å›¾åŠ è½½é”™è¯¯:', e.error);
                showMapError('åœ°å›¾åŠ è½½å¤±è´¥: ' + (e.error.message || 'æœªçŸ¥é”™è¯¯'));
            });

        } catch (error) {
            console.error('åœ°å›¾åˆå§‹åŒ–é”™è¯¯:', error);
            showMapError('åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ' + error.message);
        }

        function showMapError(message) {
            // ç§»é™¤åŠ è½½è¦†ç›–å±‚
            if (loadingOverlay && loadingOverlay.parentNode) {
                loadingOverlay.parentNode.removeChild(loadingOverlay);
            }
            
            // åˆ›å»ºé”™è¯¯è¦†ç›–å±‚
            var errorOverlay = document.createElement('div');
            errorOverlay.className = 'map-overlay map-error';
            errorOverlay.innerHTML = `
                <h5>åœ°å›¾åŠ è½½å¤±è´¥</h5>
                <p>${message}</p>
                <ul>
                    <li>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</li>
                    <li>ç¡®ä¿APIå¯†é’¥æœ‰æ•ˆ</li>
                    <li>åˆ·æ–°é¡µé¢é‡è¯•</li>
                    <li>å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·è”ç³»ç®¡ç†å‘˜</li>
                </ul>
                <button class="btn btn-primary mt-3" onclick="window.location.reload()">
                    åˆ·æ–°é¡µé¢
                </button>
            `;
            mapContainer.appendChild(errorOverlay);
        }
    });
</script>
{% endblock %}
