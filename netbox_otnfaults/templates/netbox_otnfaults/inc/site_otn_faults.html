<div id="otn-faults-injection" style="display: none;">
    {% if faults_count > 0 %}
    <a href="{% url 'plugins:netbox_otnfaults:otnfault_list' %}?site={{ site_id }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" id="unified-otn-fault-link">
        故障
        <span class="badge text-bg-primary rounded-pill">{{ faults_count }}</span>
    </a>
    {% endif %}
</div>

<script>
(function() {
    function injectOtnFaults() {
        const injectionSource = document.getElementById('unified-otn-fault-link');
        // REMOVED: if (!injectionSource) return; -> 即使没有注入源（数量为0），也需要执行移除逻辑

        // 查找页面上的所有卡片 (card)
        const cards = document.querySelectorAll('.card');
        let targetCard = null;

        // 遍历查找包含 "Related Objects" 或 "相关对象" 的卡片
        for (const card of cards) {
            const header = card.querySelector('.card-header');
            if (header) {
                const text = header.innerText.trim();
                // 兼容中英文环境
                if (text === 'Related Objects' || text === '相关对象' || text.includes('Related Objects')) {
                    targetCard = card;
                    break;
                }
            }
        }

        if (targetCard) {
            const listGroup = targetCard.querySelector('.list-group');
            if (listGroup) {
                // 1. 移除现有的“故障”条目（避免重复显示）
                const links = listGroup.querySelectorAll('a');
                links.forEach(link => {
                    // 跳过我们自己注入的这个链接 (通过ID判断)
                    if (link.id === 'unified-otn-fault-link') return;

                    const href = link.getAttribute('href');
                    const text = link.innerText.trim();
                    
                    let shouldRemove = false;

                    // 条件 1: 通过 URL 路径判断
                    // 默认插件链接通常包含 /plugins/otnfaults/faults/ 且带有 interruption_location 参数
                    if (href && href.includes('/plugins/otnfaults/faults/') && (href.includes('interruption_location_a_id') || href.includes('interruption_location_id'))) {
                        shouldRemove = true;
                    }
                    // 条件 2: 通过文本内容判断
                    else if (text === 'Fault' || text === '故障') {
                        shouldRemove = true;
                    }
                    
                    if (shouldRemove) {
                        // 如果链接本身就是 list-group-item (NetBox 原生风格)，直接移除链接
                        if (link.classList.contains('list-group-item')) {
                            link.remove();
                        } else {
                            // 否则（旧风格或 wrapper），移除其父级 li 元素
                            const listItem = link.closest('.list-group-item');
                            if (listItem) {
                                listItem.remove();
                            }
                        }
                    }
                });

                // 2. 将我们统一后的新条目添加到列表中（仅当注入源存在时）
                if (injectionSource) {
                    listGroup.appendChild(injectionSource);
                    // 移除任何可能的内联 display 样式，确保可见性
                    injectionSource.style.removeProperty('display');
                }
                
                // 清理临时注入容器
                const container = document.getElementById('otn-faults-injection');
                if (container) container.remove();
            }
        }
    }

    // 确保在 DOM 加载完成后执行
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', injectOtnFaults);
    } else {
        injectOtnFaults();
    }
})();
</script>
