{% extends 'base/layout.html' %}
{% load static %}

{% block title %}位置地图{% endblock %}

{% block content %}
<div class="row mb-3">
  <div class="col">
    <div class="card">
      <h5 class="card-header">
        {% if path_name %}
        路径地图 - {{ path_name }}
        {% else %}
        位置地图
        {% if target_lat and target_lng %}
        <span class="badge bg-primary ms-2" style="color: #fff;">{{ target_lat }}, {{ target_lng }}</span>
        {% endif %}
        {% endif %}
      </h5>
      <div class="card-body p-0">
        <div id="map" style="height: calc(-178px + 100vh); width: 100%"></div>
      </div>
    </div>
  </div>
</div>

<link
  href="{% static 'netbox_otnfaults/lib/maplibre-gl.css' %}"
  rel="stylesheet"
/>
<script src="{% static 'netbox_otnfaults/lib/maplibre-gl.js' %}"></script>
<script src="{% static 'netbox_otnfaults/lib/pmtiles.js' %}"></script>
<script src="{% static 'netbox_otnfaults/lib/deck-gl.min.js' %}"></script>
<script src="{% static 'netbox_otnfaults/lib/maplibre-gl-measures.js' %}"></script>

<link
  rel="stylesheet"
  href="{% static 'netbox_otnfaults/css/otnfault_map_globe.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'netbox_otnfaults/css/otnfault_map_controls.css' %}"
/>

<style>
  /* 去除弹窗关闭按钮的聚焦轮廓 */
  .maplibregl-popup-close-button:focus {
    outline: none;
    box-shadow: none;
  }
</style>

<script>
  window.OTNFaultMapConfig = {
      sitesData: {{ sites_data| safe }},
      targetLat: {{ target_lat|default:"null" }},
      targetLng: {{ target_lng|default:"null" }},
      highlightPathData: {{ highlight_path_data| safe }},
      pathName: {% if path_name %}"{{ path_name }}"{% else %}null{% endif %},
      apiKey: "{{ apikey }}",
      mapCenter: {{ map_center| safe }},
      mapZoom: {{ map_zoom }},
      useLocalBasemap: {{ use_local_basemap|yesno:"true,false" }},
      localTilesUrl: "{{ local_tiles_url }}",
      localGlyphsUrl: "{{ local_glyphs_url }}",
      otnPathsPmtilesUrl: "{{ otn_paths_pmtiles_url }}"
  };
</script>

<!-- Base -->
<script src="{% static 'netbox_otnfaults/js/maplibregl_base.js' %}"></script>

<!-- Services -->
<script src="{% static 'netbox_otnfaults/js/services/PopupTemplates.js' %}"></script>

<!-- App (Main) -->
<script src="{% static 'netbox_otnfaults/js/location_map_app.js' %}"></script>
{% endblock %}
