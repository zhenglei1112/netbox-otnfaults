{% extends 'generic/object.html' %}
{% load render_table from django_tables2 %}
{% load i18n %}
{% load l10n %}

{% block content %}
  <div class="row mb-3">
    <div class="col col-md-6">
      <div class="card">
        <h5 class="card-header">故障详情</h5>
          <table class="table table-hover attr-table">
            <tr>
              <th scope="row">故障编号</th>
              <td>{{ object.fault_number|default:"—" }}</td>
            </tr>
            <tr>
              <th scope="row">值守人员</th>
              <td>{{ object.duty_officer|default:"—" }}</td>
            </tr>
            <tr>
              <th scope="row">中断位置</th>
              <td>
                {% if object.interruption_location.all %}
                  {% for site in object.interruption_location.all %}
                    <a href="{{ site.get_absolute_url }}">{{ site }}</a>{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
            <tr>
              <th scope="row">故障中断时间</th>
              <td>{{ object.fault_occurrence_time|date:"Y-m-d H:i:s"|default:"—" }}</td>
            </tr>
            <tr>
              <th scope="row">故障恢复时间</th>
              <td>{{ object.fault_recovery_time|date:"Y-m-d H:i:s"|default:"—" }}</td>
            </tr>
            <tr>
              <th scope="row">中断历时</th>
              <td>{{ object.fault_duration|default:"—" }}</td>
            </tr>
            <tr>
              <th scope="row">故障分类</th>
              <td>
                {% if object.fault_category %}
                  {% badge object.get_fault_category_display bg_color=object.get_fault_category_color %}
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
            <tr>
              <th scope="row">中断原因</th>
              <td>{{ object.get_interruption_reason_display|default:"—" }}</td>
            </tr>
            <tr>
              <th scope="row">故障详细情况</th>
              <td>{{ object.fault_details|default:"—" }}</td>
            </tr>
            <tr>
              <th scope="row">GPS坐标</th>
              <td class="position-relative">
                {% if object.interruption_longitude and object.interruption_latitude %}
                  {% if config.MAPS_URL %}
                    <div class="position-absolute top-50 end-0 me-2 translate-middle-y d-print-none">
                      <a href="{{ config.MAPS_URL }}{{ object.interruption_latitude|unlocalize }},{{ object.interruption_longitude|unlocalize }}" 
                         target="_blank" 
                         class="btn btn-primary btn-sm">
                        <i class="mdi mdi-map-marker"></i> 地图
                      </a>
                    </div>
                  {% endif %}
                  <span>{{ object.interruption_latitude }}, {{ object.interruption_longitude }}</span>
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
          </table>
      </div>
      {% include 'inc/panels/custom_fields.html' %}
    </div>
    <div class="col col-md-6">
      {% include 'inc/panels/tags.html' %}
      {% include 'inc/panels/comments.html' %}
    </div>
  </div>
  
  <div class="row mb-3">
    <div class="col col-md-12">
      <div class="card">
        <h5 class="card-header">
          影响业务
          {% if perms.netbox_otnfaults.add_otnfaultimpact %}
          <div class="card-actions">
            <a href="{% url 'plugins:netbox_otnfaults:otnfaultimpact_add' %}?otn_fault={{ object.pk }}" class="btn btn-ghost-primary btn-sm">
              <i class="mdi mdi-plus-thick" aria-hidden="true"></i>
              增加一个影响的业务
            </a>
          </div>
          {% endif %}
        </h5>
          {% render_table impacts_table %}
      </div>
    </div>
  </div>
{% endblock %}
