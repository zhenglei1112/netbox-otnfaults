{% extends 'base/layout.html' %}
{% load static %}

{% block title %}æ•…éšœåˆ†å¸ƒå›¾ï¼ˆåœ°çƒæ¨¡å¼ï¼‰{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <div class="card">
            <h5 class="card-header">
                æ•…éšœåˆ†å¸ƒå›¾
                <div class="card-actions">
                    <a href="{% url 'plugins:netbox_otnfaults:otnfault_list' %}" class="btn btn-ghost-primary btn-sm">
                        <i class="mdi mdi-format-list-bulleted"></i> æŸ¥çœ‹åˆ—è¡¨
                    </a>
                </div>
            </h5>
            <div class="card-body p-0">
                <div id="map" style="height:calc(-178px + 100vh);width: 100%;"></div>
            </div>
        </div>
    </div>
</div>

<link href="https://unpkg.com/maplibre-gl@5.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@5.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@5.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@5.4.0/dist/maplibre-gl.js"></script>

<style>
    #map {
        position: relative;
        height: 600px;
        width: 100%;
    }
    .map-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .map-loading {
        background-color: rgba(248, 249, 250, 0.9);
        color: #6c757d;
    }
    .map-error {
        background-color: rgba(248, 215, 218, 0.95);
        color: #721c24;
        padding: 20px;
        text-align: center;
    }
    .map-error h5 {
        margin-bottom: 15px;
    }
    .map-error ul {
        text-align: left;
        margin: 15px 0;
    }
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    .hidden {
        display: none !important;
    }
    /* éšè—åœ°å›¾ç‰ˆæƒä¿¡æ¯ */
    .maplibregl-ctrl-attrib {
        display: none !important;
    }
    /* ç»Ÿä¸€åœ°å›¾æŒ‰é’®æ ·å¼ - ä¸æ”¾å¤§ç¼©å°å…¨å›¾æŒ‰é’®é£æ ¼ä¸€è‡´ */
    .maplibregl-ctrl-group button {
        background-color: #ffffff;
        border: 1px solid #999999; /* åŠ æ·±è¾¹æ¡†é¢œè‰²ï¼Œé¿å…åŒçº¿æ¡è§†è§‰æ•ˆæœ */
        border-radius: 4px;
        width: 32px;
        height: 32px;
        margin: 2px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.2s ease;
        color: #333333;
    }
    .maplibregl-ctrl-group button:hover {
        background-color: #f0f0f0;
        border-color: #999999; /* æ‚¬åœæ—¶ä¿æŒç›¸åŒè¾¹æ¡†é¢œè‰² */
    }
    .maplibregl-ctrl-group button.active {
        background-color: #007bff;
        color: white;
        border-color: #003d82; /* åŠ æ·±æ¿€æ´»çŠ¶æ€è¾¹æ¡†é¢œè‰²ï¼Œç¡®ä¿å•çº¿æ¡æ¸…æ™°å¯è§ */
    }
    .maplibregl-ctrl-group button.active:hover {
        background-color: #0056b3;
        border-color: #003d82; /* æ‚¬åœæ—¶ä¿æŒç›¸åŒè¾¹æ¡†é¢œè‰² */
    }
    
    /* SVGå›¾æ ‡æ ·å¼ - ç¡®ä¿é¢œè‰²æ­£ç¡®ç»§æ‰¿ */
    .maplibregl-ctrl-group button svg {
        width: 20px;
        height: 20px;
        stroke: currentColor;
        fill: none;
    }
    
    /* æ¿€æ´»çŠ¶æ€ä¸‹SVGå›¾æ ‡ä¸ºç™½è‰² */
    .maplibregl-ctrl-group button.active svg {
        stroke: white;
    }
    
    /* å›¾å±‚åˆ‡æ¢æŒ‰é’®ç‰¹å®šæ ·å¼ */
    .layer-toggle-control .toggle-button {
        /* ç»§æ‰¿åŸºç¡€æ ·å¼ */
    }
    .layer-toggle-control .heatmap-toggle.active {
        background-color: #007bff;
        border-color: #003d82; /* ç»Ÿä¸€ä½¿ç”¨æ›´æ·±çš„è“è‰²è¾¹æ¡† */
    }
    .layer-toggle-control .heatmap-toggle.active:hover {
        background-color: #0056b3;
        border-color: #003d82;
    }
    .layer-toggle-control .markers-toggle.active {
        background-color: #007bff;
        border-color: #003d82; /* ç»Ÿä¸€ä½¿ç”¨æ›´æ·±çš„è“è‰²è¾¹æ¡† */
    }
    .layer-toggle-control .markers-toggle.active:hover {
        background-color: #0056b3;
        border-color: #003d82;
    }
    .layer-toggle-control .arcgis-toggle.active {
        background-color: #007bff;
        border-color: #003d82; /* ç»Ÿä¸€ä½¿ç”¨æ›´æ·±çš„è“è‰²è¾¹æ¡† */
    }
    .layer-toggle-control .arcgis-toggle.active:hover {
        background-color: #0056b3;
        border-color: #003d82;
    }
    
    /* çƒ­åŠ›å›¾æ—¶é—´èŒƒå›´èœå•æ ·å¼ */
    .heatmap-time-range-menu {
        position: absolute;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        min-width: 120px;
        padding: 4px 0;
        display: none;
    }
    
    .dropdown-item {
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
        color: #333;
    }
    
    .dropdown-item:hover {
        background-color: #f5f5f5;
    }
    
    .dropdown-item.active {
        background-color: #007bff;
        color: white;
    }
    
    .heatmap-button-container {
        position: relative;
        display: inline-block;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var mapContainer = document.getElementById('map');
        
        // åˆ›å»ºåŠ è½½è¦†ç›–å±‚
        var loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'map-overlay map-loading';
            loadingOverlay.innerHTML = `
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <div class="mt-3">æ­£åœ¨åŠ è½½åœ°çƒæ¨¡å¼åœ°å›¾...</div>
        `;
        mapContainer.appendChild(loadingOverlay);
        
        // SVGå›¾æ ‡å®šä¹‰ - é»‘ç™½çº¿æ¡é£æ ¼ï¼Œä¸æ”¾å¤§ç¼©å°æŒ‰é’®ä¸€è‡´
        var svgIcons = {
            home: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>',
            heatmap: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>',
            marker: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>',
            network: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="8" r="2"/><circle cx="16" cy="8" r="2"/><circle cx="12" cy="16" r="2"/><line x1="8" y1="8" x2="16" y2="8"/><line x1="8" y1="8" x2="12" y2="16"/><line x1="16" y1="8" x2="12" y2="16"/></svg>'
        };
        
        try {
            // éªŒè¯æ•°æ®æ ¼å¼
            var heatmapData = {{ heatmap_data|safe }};
            var markerData = {{ marker_data|safe }};
            var apiKey = "{{ apikey }}";
            
            // æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰æ•ˆ
            if (!Array.isArray(heatmapData)) {
                console.warn('heatmap_data ä¸æ˜¯æœ‰æ•ˆçš„æ•°ç»„ï¼Œä½¿ç”¨ç©ºæ•°ç»„');
                heatmapData = [];
            }
            if (!Array.isArray(markerData)) {
                console.warn('marker_data ä¸æ˜¯æœ‰æ•ˆçš„æ•°ç»„ï¼Œä½¿ç”¨ç©ºæ•°ç»„');
                markerData = [];
            }

            // æ£€æŸ¥ Maplibre GL æ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof maplibregl === 'undefined') {
                throw new Error('åœ°å›¾åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢');
            }

            var map = new maplibregl.Map({
                container: 'map',
                style: 'https://tiles.stadiamaps.com/styles/alidade_smooth.json?api_key=' + apiKey,
                center: [105.0, 35.0], // é»˜è®¤ä¸­å¿ƒç‚¹ï¼ˆä¸­å›½ï¼‰
                zoom: 4
            });

            map.addControl(new maplibregl.NavigationControl());
            
            // æ·»åŠ å…¨å±æ§ä»¶
            map.addControl(new maplibregl.FullscreenControl({
                container: document.querySelector('#map')
            }));

            // æ·»åŠ HomeæŒ‰é’®æ§ä»¶ï¼Œç”¨äºæ¢å¤åˆå§‹è§†é‡
            class HomeControl {
                constructor(options) {
                    this.options = options || {};
                    this.initialCenter = [105.0, 35.0]; // é»˜è®¤ä¸­å¿ƒç‚¹ï¼ˆä¸­å›½ï¼‰
                    this.initialZoom = 4;
                }
                
                onAdd(map) {
                    this.map = map;
                    this.container = document.createElement('div');
                    this.container.className = 'maplibregl-ctrl maplibregl-ctrl-group';
                    
                    // HomeæŒ‰é’® - ä½¿ç”¨SVGå›¾æ ‡
                    this.homeButton = document.createElement('button');
                    this.homeButton.className = 'maplibregl-ctrl-icon';
                    this.homeButton.innerHTML = svgIcons.home;
                    this.homeButton.title = 'æ¢å¤åˆå§‹è§†é‡ï¼ˆåŒ…æ‹¬æ¯”ä¾‹å°ºã€è§†é‡ã€åŒ—å‘ã€ä¿¯ä»°ç­‰ï¼‰';
                    this.homeButton.onclick = () => this.goHome();
                    
                    this.container.appendChild(this.homeButton);
                    
                    return this.container;
                }
                
                onRemove() {
                    this.container.parentNode.removeChild(this.container);
                    this.map = undefined;
                }
                
                goHome() {
                    console.log('HomeæŒ‰é’®ç‚¹å‡»ï¼šå®Œå…¨æ¢å¤åˆ°åˆå§‹çª—å£çŠ¶æ€');
                    
                    // å®Œå…¨æ¢å¤åˆ°åˆå§‹çª—å£çŠ¶æ€ï¼ŒåŒ…æ‹¬æ¯”ä¾‹å°ºã€è§†é‡ã€åŒ—å‘ã€ä¿¯ä»°ç­‰æ‰€æœ‰å†…å®¹
                    this.map.flyTo({
                        center: this.initialCenter,  // ä¸­å¿ƒç‚¹ï¼š[105.0, 35.0]
                        zoom: this.initialZoom,      // ç¼©æ”¾çº§åˆ«ï¼š4
                        bearing: 0,                  // æ–¹ä½è§’ï¼š0åº¦ï¼ˆæ­£åŒ—æ–¹å‘ï¼‰
                        pitch: 0,                    // ä¿¯ä»°è§’ï¼š0åº¦ï¼ˆæ°´å¹³è§†è§’ï¼‰
                        essential: true
                    });
                    
                    // ç¡®ä¿åœ°çƒæŠ•å½±æ¨¡å¼
                    this.map.setProjection({ type: 'globe' });
                    
                    console.log('å·²æ¢å¤ï¼šä¸­å¿ƒç‚¹=' + this.initialCenter + 
                              ', ç¼©æ”¾=' + this.initialZoom + 
                              ', æ–¹ä½è§’=0, ä¿¯ä»°è§’=0, æŠ•å½±æ¨¡å¼=globe');
                }
            }
            
            // æ·»åŠ Homeæ§ä»¶åˆ°åœ°å›¾ï¼ˆåœ¨å…¨å±æ§ä»¶ä¸‹æ–¹ï¼‰
            map.addControl(new HomeControl(), 'top-right');

            // åˆ›å»ºå›¾å±‚åˆ‡æ¢æ§ä»¶
            class LayerToggleControl {
                constructor(options) {
                    this.options = options || {};
                    this.heatmapVisible = true;
                    this.markersVisible = true;
                    this.arcgisVisible = true;
                    this.markers = []; // å­˜å‚¨æ ‡è®°å¯¹è±¡
                    this.currentTimeRange = 'year'; // é»˜è®¤æ—¶é—´èŒƒå›´ï¼šæœ¬å¹´
                    this.menuHovered = false; // èœå•æ‚¬åœçŠ¶æ€
                    this.lastMouseX = 0; // é¼ æ ‡Xåæ ‡
                    this.lastMouseY = 0; // é¼ æ ‡Yåæ ‡
                    
                    // è·Ÿè¸ªé¼ æ ‡ä½ç½®
                    document.addEventListener('mousemove', (e) => {
                        this.lastMouseX = e.clientX;
                        this.lastMouseY = e.clientY;
                    });
                }
                
                onAdd(map) {
                    this.map = map;
                    this.container = document.createElement('div');
                    this.container.className = 'maplibregl-ctrl maplibregl-ctrl-group layer-toggle-control';
                    
                    // åˆ›å»ºçƒ­åŠ›å›¾æŒ‰é’®å®¹å™¨ï¼ˆç”¨äºå®šä½å¼¹å‡ºèœå•ï¼‰
                    this.heatmapContainer = document.createElement('div');
                    this.heatmapContainer.className = 'heatmap-button-container';
                    this.heatmapContainer.style.position = 'relative';
                    
                    // çƒ­åŠ›å›¾å¼€å…³æŒ‰é’® - ä½¿ç”¨SVGå›¾æ ‡
                    this.heatmapButton = document.createElement('button');
                    this.heatmapButton.className = 'maplibregl-ctrl-icon toggle-button heatmap-toggle active';
                    this.heatmapButton.innerHTML = svgIcons.heatmap;
                    this.heatmapButton.title = 'çƒ­åŠ›å›¾å¼€å…³ - å½“å‰èŒƒå›´: æœ¬å¹´ (æ‚¬åœæ˜¾ç¤ºæ—¶é—´èœå•)';
                    
                    // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºæ—¶é—´èŒƒå›´èœå•
                    this.heatmapButton.addEventListener('mouseenter', (e) => {
                        e.stopPropagation();
                        this.showTimeRangeMenu();
                    });
                    
                    // é¼ æ ‡ç¦»å¼€éšè—æ—¶é—´èŒƒå›´èœå•ï¼ˆå»¶è¿Ÿéšè—ï¼Œé¿å…èœå•æ— æ³•ç‚¹å‡»ï¼‰
                    this.heatmapButton.addEventListener('mouseleave', (e) => {
                        e.stopPropagation();
                        // å»¶è¿Ÿéšè—ï¼Œç»™ç”¨æˆ·æ—¶é—´ç§»åŠ¨åˆ°èœå•
                        setTimeout(() => {
                            if (!this.isMouseOverMenu()) {
                                this.hideTimeRangeMenu();
                            }
                        }, 300);
                    });
                    
                    // å•å‡»åˆ‡æ¢çƒ­åŠ›å›¾å±‚æ˜¾ç¤º/éšè—
                    this.heatmapButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleHeatmap();
                    });
                    
                    // åˆ›å»ºæ—¶é—´èŒƒå›´èœå•
                    this.createTimeRangeMenu();
                    
                    // æ•…éšœç‚¹å¼€å…³æŒ‰é’® - ä½¿ç”¨SVGå›¾æ ‡
                    this.markersButton = document.createElement('button');
                    this.markersButton.className = 'maplibregl-ctrl-icon toggle-button markers-toggle active';
                    this.markersButton.innerHTML = svgIcons.marker;
                    this.markersButton.title = 'æ•…éšœç‚¹å¼€å…³';
                    this.markersButton.onclick = () => this.toggleMarkers();
                    
                    // ArcGISå›¾å±‚å¼€å…³æŒ‰é’®ï¼ˆç»Ÿä¸€æ§åˆ¶æ‰€æœ‰ArcGISå›¾å±‚ï¼‰- ä½¿ç”¨SVGå›¾æ ‡
                    this.arcgisButton = document.createElement('button');
                    this.arcgisButton.className = 'maplibregl-ctrl-icon toggle-button arcgis-toggle';
                    this.arcgisButton.innerHTML = svgIcons.network;
                    this.arcgisButton.title = 'OTNç½‘ç»œå›¾å±‚';
                    this.arcgisButton.onclick = () => this.toggleArcgis();
                    
                    // æ ¹æ®åˆå§‹å¯è§æ€§è®¾ç½®æŒ‰é’®çŠ¶æ€
                    if (this.arcgisVisible) {
                        this.arcgisButton.classList.add('active');
                    }
                    
                    this.heatmapContainer.appendChild(this.heatmapButton);
                    this.container.appendChild(this.heatmapContainer);
                    this.container.appendChild(this.markersButton);
                    this.container.appendChild(this.arcgisButton);
                    
                    return this.container;
                }
                
                onRemove() {
                    this.container.parentNode.removeChild(this.container);
                    this.map = undefined;
                }
                
                createTimeRangeMenu() {
                    this.timeRangeMenu = document.createElement('div');
                    this.timeRangeMenu.className = 'heatmap-time-range-menu';
                    
                    // èœå•é¡¹æ•°æ®
                    const menuItems = [
                        { range: 'month', text: 'ä¸€ä¸ªæœˆ' },
                        { range: 'three_months', text: 'ä¸‰ä¸ªæœˆ' },
                        { range: 'year', text: 'æœ¬å¹´' }
                    ];
                    
                    // åŠ¨æ€ç”Ÿæˆèœå•é¡¹
                    menuItems.forEach(item => {
                        const menuItem = document.createElement('div');
                        menuItem.className = 'dropdown-item';
                        menuItem.setAttribute('data-range', item.range);
                        menuItem.textContent = item.text;
                        
                        // å¦‚æœæ˜¯å½“å‰é€‰æ‹©é¡¹ï¼Œæ·»åŠ é«˜äº®ç±»
                        if (item.range === this.currentTimeRange) {
                            menuItem.classList.add('active');
                        }
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        menuItem.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const range = e.target.getAttribute('data-range');
                            this.selectTimeRange(range);
                            this.hideTimeRangeMenu();
                        });
                        
                        this.timeRangeMenu.appendChild(menuItem);
                    });
                    
                    // èœå•é¼ æ ‡äº‹ä»¶
                    this.timeRangeMenu.addEventListener('mouseenter', () => {
                        this.menuHovered = true;
                    });
                    
                    this.timeRangeMenu.addEventListener('mouseleave', () => {
                        this.menuHovered = false;
                        setTimeout(() => {
                            if (!this.menuHovered && !this.isMouseOverButton()) {
                                this.hideTimeRangeMenu();
                            }
                        }, 300);
                    });
                    
                    this.heatmapContainer.appendChild(this.timeRangeMenu);
                    
                    // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—èœå•
                    document.addEventListener('click', () => {
                        this.hideTimeRangeMenu();
                    });
                }
                
                isMouseOverMenu() {
                    return this.menuHovered || false;
                }
                
                isMouseOverButton() {
                    // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨æŒ‰é’®ä¸Š
                    if (!this.heatmapButton) return false;
                    const rect = this.heatmapButton.getBoundingClientRect();
                    const mouseX = this.lastMouseX || 0;
                    const mouseY = this.lastMouseY || 0;
                    return mouseX >= rect.left && mouseX <= rect.right && 
                           mouseY >= rect.top && mouseY <= rect.bottom;
                }
                
                showTimeRangeMenu() {
                    // éšè—å…¶ä»–å¯èƒ½æ‰“å¼€çš„èœå•
                    this.hideTimeRangeMenu();
                    
                    // æ˜¾ç¤ºèœå•
                    this.timeRangeMenu.style.display = 'block';
                    
                    // å®šä½èœå•åœ¨æŒ‰é’®ä¸‹æ–¹
                    const rect = this.heatmapButton.getBoundingClientRect();
                    this.timeRangeMenu.style.position = 'absolute';
                    this.timeRangeMenu.style.top = '100%';
                    this.timeRangeMenu.style.left = '0';
                    this.timeRangeMenu.style.zIndex = '1000';
                }
                
                hideTimeRangeMenu() {
                    if (this.timeRangeMenu) {
                        this.timeRangeMenu.style.display = 'none';
                    }
                }
                
                selectTimeRange(range) {
                    this.currentTimeRange = range;
                    
                    // æ›´æ–°æŒ‰é’®æ ‡é¢˜
                    let rangeText = 'æœ¬å¹´';  // é»˜è®¤å€¼
                    if (range === 'month') rangeText = 'ä¸€ä¸ªæœˆ';
                    else if (range === 'three_months') rangeText = 'ä¸‰ä¸ªæœˆ';
                    
                    this.heatmapButton.title = `çƒ­åŠ›å›¾å¼€å…³ - å½“å‰èŒƒå›´: ${rangeText}`;
                    
                    // æ›´æ–°èœå•é¡¹é«˜äº®çŠ¶æ€
                    this.updateMenuHighlight();
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    this.reloadHeatmapData(range);
                }
                
                updateMenuHighlight() {
                    // æ›´æ–°æ‰€æœ‰èœå•é¡¹çš„é«˜äº®çŠ¶æ€
                    if (this.timeRangeMenu) {
                        const menuItems = this.timeRangeMenu.querySelectorAll('.dropdown-item');
                        menuItems.forEach(item => {
                            const range = item.getAttribute('data-range');
                            if (range === this.currentTimeRange) {
                                item.classList.add('active');
                            } else {
                                item.classList.remove('active');
                            }
                        });
                    }
                }
                
                reloadHeatmapData(timeRange) {
                    // è®¡ç®—èµ·å§‹æ—¥æœŸ
                    const now = new Date();
                    let startDate;
                    
                    if (timeRange === 'month') {
                        startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                    } else if (timeRange === 'three_months') {
                        startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
                    } else { // 'year' æˆ– 'all'
                        // æœ¬å¹´1æœˆ1æ—¥
                        startDate = new Date(now.getFullYear(), 0, 1);
                    }
                    
                    // ç­›é€‰æ•°æ®ï¼šåªä¿ç•™å‘ç”Ÿæ—¶é—´åœ¨èµ·å§‹æ—¥æœŸä¹‹åçš„æ•°æ®ç‚¹
                    const filteredData = heatmapData.filter(point => {
                        if (!point.occurrence_time) return false;
                        const pointDate = new Date(point.occurrence_time);
                        return pointDate >= startDate;
                    });
                    
                    console.log(`å‰ç«¯ç­›é€‰çƒ­åŠ›å›¾æ•°æ®ï¼Œæ—¶é—´èŒƒå›´: ${timeRange}, åŸå§‹æ•°æ®ç‚¹: ${heatmapData.length}, ç­›é€‰åæ•°æ®ç‚¹: ${filteredData.length}`);
                    
                    // å°†ç­›é€‰ç»“æœè½¬æ¢ä¸ºGeoJSONæ ¼å¼
                    const features = filteredData.map(point => ({
                        type: 'Feature',
                        properties: { count: point.count },
                        geometry: {
                            type: 'Point',
                            coordinates: [point.lng, point.lat]
                        }
                    }));
                    
                    const geoJsonData = {
                        type: 'FeatureCollection',
                        features: features
                    };
                    
                    // æ›´æ–°åœ°å›¾æ•°æ®æº
                    if (this.map.getSource('faults')) {
                        this.map.getSource('faults').setData(geoJsonData);
                    }
                    
                    // æ›´æ–°æŒ‰é’®æ ‡é¢˜
                    this.updateButtonTitle(timeRange);
                }
                
                showLoading() {
                    // åˆ›å»ºæˆ–æ˜¾ç¤ºåŠ è½½æç¤º
                    if (!this.loadingOverlay) {
                        this.loadingOverlay = document.createElement('div');
                        this.loadingOverlay.className = 'heatmap-loading-overlay';
                        this.loadingOverlay.innerHTML = `
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <div class="mt-2">æ­£åœ¨åŠ è½½çƒ­åŠ›å›¾æ•°æ®...</div>
                        `;
                        this.loadingOverlay.style.cssText = `
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background-color: rgba(255, 255, 255, 0.8);
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            z-index: 9999;
                            border-radius: 4px;
                        `;
                        this.heatmapContainer.appendChild(this.loadingOverlay);
                    }
                    this.loadingOverlay.style.display = 'flex';
                }
                
                hideLoading() {
                    if (this.loadingOverlay) {
                        this.loadingOverlay.style.display = 'none';
                    }
                }
                
                updateButtonTitle(timeRange) {
                    let rangeText = 'æœ¬å¹´';  // é»˜è®¤å€¼
                    if (timeRange === 'month') rangeText = 'ä¸€ä¸ªæœˆ';
                    else if (timeRange === 'three_months') rangeText = 'ä¸‰ä¸ªæœˆ';
                    
                    this.heatmapButton.title = `çƒ­åŠ›å›¾å¼€å…³ - å½“å‰èŒƒå›´: ${rangeText}`;
                    this.currentTimeRange = timeRange;
                }
                
                // å¯é€‰ï¼šå›é€€åˆ°é¡µé¢åˆ·æ–°æ–¹å¼
                fallbackToPageRefresh(timeRange) {
                    console.warn('ä½¿ç”¨é¡µé¢åˆ·æ–°æ–¹å¼ä½œä¸ºå›é€€');
                    const currentUrl = window.location.href.split('?')[0];
                    let newUrl = currentUrl;
                    if (timeRange !== 'year') {
                        newUrl = `${currentUrl}?time_range=${timeRange}`;
                    }
                    window.location.href = newUrl;
                }
                
                toggleHeatmap() {
                    this.heatmapVisible = !this.heatmapVisible;
                    if (this.heatmapVisible) {
                        this.heatmapButton.classList.add('active');
                        this.map.setLayoutProperty('faults-heat', 'visibility', 'visible');
                    } else {
                        this.heatmapButton.classList.remove('active');
                        this.map.setLayoutProperty('faults-heat', 'visibility', 'none');
                    }
                }
                
                toggleMarkers() {
                    this.markersVisible = !this.markersVisible;
                    if (this.markersVisible) {
                        this.markersButton.classList.add('active');
                        // æ˜¾ç¤ºæ‰€æœ‰æ ‡è®°
                        this.markers.forEach(marker => marker.getElement().style.display = 'block');
                    } else {
                        this.markersButton.classList.remove('active');
                        // éšè—æ‰€æœ‰æ ‡è®°
                        this.markers.forEach(marker => marker.getElement().style.display = 'none');
                    }
                }
                
                toggleArcgis() {
                    this.arcgisVisible = !this.arcgisVisible;
                    console.log('ArcGISæŒ‰é’®åˆ‡æ¢ï¼Œæ–°çŠ¶æ€:', this.arcgisVisible ? 'æ˜¾ç¤º' : 'éšè—');
                    this.updateArcgisLayersVisibility();
                }
                
                updateArcgisLayersVisibility() {
                    console.log('æ›´æ–°ArcGISå›¾å±‚å¯è§æ€§ï¼Œå½“å‰çŠ¶æ€:', this.arcgisVisible ? 'æ˜¾ç¤º' : 'éšè—');
                    
                    if (!this.arcgisVisible) {
                        // å¦‚æœå¼€å…³å…³é—­ï¼Œéšè—æ‰€æœ‰ArcGISå›¾å±‚ï¼ˆåŒ…æ‹¬æ–‡æœ¬æ ‡æ³¨å›¾å±‚ï¼‰
                        ['arcgis-otn-points-0', 'arcgis-otn-points-1', 'arcgis-otn-lines-2', 'arcgis-otn-lines-3', 'arcgis-otn-labels-0', 'arcgis-otn-labels-1'].forEach(layerId => {
                            if (this.map.getLayer(layerId)) {
                                this.map.setLayoutProperty(layerId, 'visibility', 'none');
                            }
                        });
                        // ç¡®ä¿æŒ‰é’®çŠ¶æ€æ›´æ–°
                        this.arcgisButton.classList.remove('active');
                        console.log('ArcGISå›¾å±‚å·²éšè—ï¼ŒæŒ‰é’®çŠ¶æ€æ›´æ–°ä¸º: éæ¿€æ´»');
                        return;
                    }
                    
                    // å¼€å…³æ‰“å¼€æ—¶ï¼Œæ ¹æ®ç¼©æ”¾çº§åˆ«æ§åˆ¶å›¾å±‚æ˜¾ç¤º
                    const currentZoom = this.map.getZoom();
                    const isNationalView = currentZoom <= 4;    // å…¨å›½è§†é‡ï¼šç¼©æ”¾çº§åˆ« â‰¤ 6
                    const isProvincialView = currentZoom >= 5;  // çœçº§è§†é‡ï¼šç¼©æ”¾çº§åˆ« â‰¥ 8
                    
                    console.log('å½“å‰ç¼©æ”¾çº§åˆ«:', currentZoom, 'å…¨å›½è§†é‡:', isNationalView, 'çœçº§è§†é‡:', isProvincialView);
                    
                    // çº¿å›¾å±‚ï¼šå…¨å›½è§†é‡æ—¶æ˜¾ç¤ºï¼Œçœçº§è§†é‡æ—¶ä¹Ÿæ˜¾ç¤ºï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
                    if (this.map.getLayer('arcgis-otn-lines-2')) {
                        this.map.setLayoutProperty('arcgis-otn-lines-2', 'visibility', 'visible');
                        console.log('çº¿å›¾å±‚2è®¾ç½®ä¸ºå¯è§');
                    }
                    if (this.map.getLayer('arcgis-otn-lines-3')) {
                        this.map.setLayoutProperty('arcgis-otn-lines-3', 'visibility', 'visible');
                        console.log('çº¿å›¾å±‚3è®¾ç½®ä¸ºå¯è§');
                    }
                    
                    // ç‚¹å›¾å±‚å’Œæ–‡æœ¬æ ‡æ³¨å›¾å±‚ï¼šåªåœ¨çœçº§è§†é‡æ—¶æ˜¾ç¤º
                    const pointVisibility = isProvincialView ? 'visible' : 'none';
                    console.log('ç‚¹å›¾å±‚å¯è§æ€§:', pointVisibility);
                    
                    if (this.map.getLayer('arcgis-otn-points-0')) {
                        this.map.setLayoutProperty('arcgis-otn-points-0', 'visibility', pointVisibility);
                        console.log('ç‚¹å›¾å±‚0è®¾ç½®ä¸º:', pointVisibility);
                    }
                    if (this.map.getLayer('arcgis-otn-points-1')) {
                        this.map.setLayoutProperty('arcgis-otn-points-1', 'visibility', pointVisibility);
                        console.log('ç‚¹å›¾å±‚1è®¾ç½®ä¸º:', pointVisibility);
                    }
                    if (this.map.getLayer('arcgis-otn-labels-0')) {
                        this.map.setLayoutProperty('arcgis-otn-labels-0', 'visibility', pointVisibility);
                        console.log('æ ‡ç­¾å›¾å±‚0è®¾ç½®ä¸º:', pointVisibility);
                    }
                    if (this.map.getLayer('arcgis-otn-labels-1')) {
                        this.map.setLayoutProperty('arcgis-otn-labels-1', 'visibility', pointVisibility);
                        console.log('æ ‡ç­¾å›¾å±‚1è®¾ç½®ä¸º:', pointVisibility);
                    }
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    this.arcgisButton.classList.add('active');
                    console.log('ArcGISå›¾å±‚å·²æ˜¾ç¤ºï¼ŒæŒ‰é’®çŠ¶æ€æ›´æ–°ä¸º: æ¿€æ´»');
                }
                
                addMarker(marker) {
                    this.markers.push(marker);
                }
            }
            
            // æ·»åŠ å›¾å±‚åˆ‡æ¢æ§ä»¶
            var layerToggleControl = new LayerToggleControl();
            map.addControl(layerToggleControl, 'top-left');

            // åœ¨æ ·å¼åŠ è½½æ—¶ç«‹å³è®¾ç½®ä¸­æ–‡æ ‡ç­¾
            map.on('style.load', function () {
                // è®¾ç½®åœ°å›¾è¯­è¨€ä¸ºä¸­æ–‡
                function setMapLanguageToChinese() {
                    const layers = map.getStyle().layers;
                    layers.forEach(layer => {
                        if (layer.layout && layer.layout['text-field']) {
                            map.setLayoutProperty(layer.id, 'text-field', ['coalesce', ['get', 'name:zh'], ['get', 'name']]);
                        }
                    });
                }
                
                // è¿‡æ»¤åœ°å›¾æ ‡ç­¾ - åªæ˜¾ç¤ºåŸå¸‚è¡Œæ”¿åï¼Œéšè—æ‰€æœ‰é“è·¯åç§°
                function filterCityLabels() {
                    const layers = map.getStyle().layers;
                    console.log('å¼€å§‹è¿‡æ»¤åœ°å›¾æ ‡ç­¾ï¼Œéšè—é“è·¯åç§°ï¼Œåªæ˜¾ç¤ºåŸå¸‚è¡Œæ”¿å');
                    
                    layers.forEach(layer => {
                        if (layer.type === 'symbol') {
                            // éšè—æ‰€æœ‰é“è·¯ç›¸å…³æ ‡ç­¾
                            if (layer.id.includes('road') || 
                                layer.id.includes('highway') ||
                                layer.id.includes('street') ||
                                layer.id.includes('route') ||
                                layer.id.includes('motorway') ||
                                layer.id.includes('trunk') ||
                                layer.id.includes('primary') ||
                                layer.id.includes('secondary') ||
                                layer.id.includes('tertiary') ||
                                layer.id.includes('path') ||
                                layer.id.includes('track') ||
                                layer.id.includes('service') ||
                                layer.id.includes('pedestrian') ||
                                layer.id.includes('cycleway') ||
                                layer.id.includes('footway') ||
                                layer.id.includes('steps') ||
                                layer.id.includes('ferry') ||
                                layer.id.includes('rail') ||
                                layer.id.includes('transit')) {
                                map.setLayoutProperty(layer.id, 'visibility', 'none');
                                console.log('éšè—é“è·¯æ ‡ç­¾:', layer.id);
                            }
                            
                            // ä¿ç•™åŸå¸‚è¡Œæ”¿æ ‡ç­¾ï¼Œä½†è¿‡æ»¤å°åŸé•‡
                            if ((layer.id.includes('place') || layer.id.includes('settlement') ||
                                 layer.id.includes('label')) &&
                                (layer.id.includes('village') || layer.id.includes('town') ||
                                 layer.id.includes('hamlet') || layer.id.includes('suburb') ||
                                 layer.id.includes('neighbourhood') || layer.id.includes('neighborhood') ||
                                 layer.id.includes('quarter') || layer.id.includes('locality') ||
                                 layer.id.includes('isolated_dwelling'))) {
                                map.setLayoutProperty(layer.id, 'visibility', 'none');
                                console.log('éšè—å°åŸé•‡æ ‡ç­¾:', layer.id);
                            }
                        }
                    });
                    
                    console.log('åœ°å›¾æ ‡ç­¾è¿‡æ»¤å®Œæˆ');
                }
                
                // ç«‹å³è°ƒç”¨ä¸­æ–‡æ ‡ç­¾è®¾ç½®å‡½æ•°
                setMapLanguageToChinese();
                // è¿‡æ»¤åŸå¸‚æ ‡ç­¾ï¼Œåªæ˜¾ç¤ºä¸»è¦åŸå¸‚
                filterCityLabels();
            });

            map.on('load', function () {
                // è®¾ç½®åœ°çƒæŠ•å½±æ¨¡å¼
                map.setProjection({ type: 'globe' });
                
                // å‡†å¤‡çƒ­åŠ›å›¾çš„GeoJSONæ•°æ®
                var features = heatmapData.map(function (point) {
                    return {
                        type: 'Feature',
                        properties: { count: point.count },
                        geometry: {
                            type: 'Point',
                            coordinates: [point.lng, point.lat]
                        }
                    };
                });

                // å°†åœ°å›¾è¾¹ç•Œé€‚é…åˆ°æ•°æ®èŒƒå›´
                var bounds = new maplibregl.LngLatBounds();
                if (features.length > 0) {
                    features.forEach(function (feature) {
                        bounds.extend(feature.geometry.coordinates);
                    });
                }
                // åŒæ—¶å°†æ ‡è®°ç‚¹åŒ…å«åœ¨è¾¹ç•Œå†…
                markerData.forEach(function (m) {
                    bounds.extend([m.lng, m.lat]);
                });

                if (!bounds.isEmpty()) {
                    map.fitBounds(bounds, { padding: 50 });
                }

                // æ•…éšœåˆ†ç±»é¢œè‰²æ˜ å°„
                var faultCategoryColors = {
                    'network': '#FF0000',      // ç½‘ç»œæ•…éšœ - çº¢è‰²
                    'equipment': '#FFA500',    // è®¾å¤‡æ•…éšœ - æ©™è‰²
                    'power': '#FFFF00',        // ç”µæºæ•…éšœ - é»„è‰²
                    'optical': '#00FF00',      // å…‰ç¼†æ•…éšœ - ç»¿è‰²
                    'software': '#0000FF',     // è½¯ä»¶æ•…éšœ - è“è‰²
                    'other': '#800080'         // å…¶ä»–æ•…éšœ - ç´«è‰²
                };
                
                // æ•…éšœåˆ†ç±»åç§°æ˜ å°„
                var faultCategoryNames = {
                    'network': 'ç½‘ç»œæ•…éšœ',
                    'equipment': 'è®¾å¤‡æ•…éšœ',
                    'power': 'ç”µæºæ•…éšœ',
                    'optical': 'å…‰ç¼†æ•…éšœ',
                    'software': 'è½¯ä»¶æ•…éšœ',
                    'other': 'å…¶ä»–æ•…éšœ'
                };
                
                // æ·»åŠ æœ€è¿‘ä¸€å‘¨æ•…éšœç‚¹çš„æ ‡è®° - æ ¹æ®æ•…éšœåˆ†ç±»æ˜¾ç¤ºä¸åŒé¢œè‰²
                markerData.forEach(function (m) {
                    // è·å–æ•…éšœåˆ†ç±»ï¼Œé»˜è®¤ä¸º'other'
                    var category = m.category || 'other';
                    var color = faultCategoryColors[category] || faultCategoryColors['other'];
                    var categoryName = faultCategoryNames[category] || faultCategoryNames['other'];
                    
                    // æ„å»ºè¯¦ç»†çš„popupå†…å®¹
                    var popupContent = '<div style="max-width: 450px; max-height: 500px; overflow-y: auto; font-size: 13px;">' +
                        '<div style="border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 12px;">' +
                        '<h6 style="margin: 0 0 8px 0; font-size: 16px;">' +
                        '<a href="' + m.url + '" target="_blank" style="color: #007bff; text-decoration: none;">' + m.number + '</a>' +
                        '</h6>' +
                        '<div style="display: inline-block; padding: 2px 8px; background-color: ' + color + '; color: white; border-radius: 3px; font-size: 12px;">' +
                        categoryName +
                        '</div>' +
                        '</div>' +
                        
                        '<table style="width: 100%; border-collapse: collapse; margin-bottom: 12px;">' +
                        '<tr>' +
                        '<td style="width: 35%; padding: 6px 8px; border-bottom: 1px solid #eee; font-weight: bold;">çœä»½:</td>' +
                        '<td style="padding: 6px 8px; border-bottom: 1px solid #eee;">' + (m.province || 'æœªæŒ‡å®š') + '</td>' +
                        '</tr>' +
                        '<tr>' +
                        '<td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-weight: bold;">Aç«¯ç«™ç‚¹:</td>' +
                        '<td style="padding: 6px 8px; border-bottom: 1px solid #eee;">' + (m.a_site || 'æœªæŒ‡å®š') + '</td>' +
                        '</tr>' +
                        '<tr>' +
                        '<td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-weight: bold;">Zç«¯ç«™ç‚¹:</td>' +
                        '<td style="padding: 6px 8px; border-bottom: 1px solid #eee;">' + (m.z_sites || 'æœªæŒ‡å®š') + '</td>' +
                        '</tr>' +
                        '<tr>' +
                        '<td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-weight: bold;">ä¸­æ–­æ—¶é—´:</td>' +
                        '<td style="padding: 6px 8px; border-bottom: 1px solid #eee;">' + m.occurrence_time + '</td>' +
                        '</tr>' +
                        '<tr>' +
                        '<td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-weight: bold;">æ¢å¤æ—¶é—´:</td>' +
                        '<td style="padding: 6px 8px; border-bottom: 1px solid #eee;">' + m.recovery_time + '</td>' +
                        '</tr>' +
                        '<tr>' +
                        '<td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-weight: bold;">æ•…éšœå†æ—¶:</td>' +
                        '<td style="padding: 6px 8px; border-bottom: 1px solid #eee;">' + (m.fault_duration || 'æ— æ³•è®¡ç®—') + '</td>' +
                        '</tr>' +
                        '</table>' +
                        
                        '<div style="margin-bottom: 12px;">' +
                        '<div style="font-weight: bold; margin-bottom: 6px;">æ•…éšœè¯¦æƒ…:</div>' +
                        '<div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px; max-height: 150px; overflow-y: auto; line-height: 1.5;">' +
                        (m.fault_details || 'æ— è¯¦ç»†æè¿°') +
                        '</div>' +
                        '</div>';
                    
                    // å¦‚æœæœ‰ç…§ç‰‡ï¼Œæ·»åŠ ç…§ç‰‡ä¿¡æ¯
                    if (m.has_images && m.image_count > 0) {
                        popupContent += '<div style="margin-bottom: 12px;">' +
                            '<div style="font-weight: bold; margin-bottom: 6px;">æ•…éšœç…§ç‰‡:</div>' +
                            '<div style="padding: 8px; background-color: #e9ecef; border-radius: 4px; font-size: 12px;">' +
                            '<div style="display: flex; align-items: center; margin-bottom: 4px;">' +
                            '<span style="margin-right: 8px;">ğŸ“·</span>' +
                            '<span>å…± ' + m.image_count + ' å¼ ç…§ç‰‡</span>' +
                            '</div>' +
                            '<div style="color: #666; font-size: 11px;">ç‚¹å‡»ä¸Šæ–¹æ•…éšœç¼–å·æŸ¥çœ‹è¯¦æƒ…é¡µé¢ä¸­çš„ç…§ç‰‡</div>' +
                            '</div>' +
                            '</div>';
                    }
                    
                    popupContent += '<div style="text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; font-size: 11px; color: #666;">' +
                        'ç‚¹å‡»æ ‡è®°ç‚¹å¯æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼Œç‚¹å‡»æ•…éšœç¼–å·å¯æŸ¥çœ‹å®Œæ•´è¯¦æƒ…' +
                        '</div>' +
                        '</div>';
                    
                    var popup = new maplibregl.Popup({ offset: 25, maxWidth: '500px' }).setHTML(popupContent);

                    var marker = new maplibregl.Marker({ color: color })
                        .setLngLat([m.lng, m.lat])
                        .setPopup(popup)
                        .addTo(map);
                    
                    // å°†æ ‡è®°æ·»åŠ åˆ°åˆ‡æ¢æ§ä»¶ä¸­
                    layerToggleControl.addMarker(marker);
                });
                
                // æ·»åŠ ArcGIS OTNç½‘ç»œå›¾å±‚ï¼ˆ4ä¸ªå›¾å±‚ï¼‰
                try {
                    // é¦–å…ˆæ·»åŠ çº¿å›¾å±‚ï¼ˆç½®äºåº•å›¾ä¹‹ä¸Šï¼Œå…¶ä»–å›¾å±‚ä¹‹ä¸‹ï¼‰
                    // å›¾å±‚2ï¼šçº¿å›¾å±‚
                    var arcgisUrl2 = 'http://192.168.70.216:6080/arcgis/rest/services/OTN/OTN/FeatureServer/2/query?where=1%3D1&outFields=*&f=geojson';
                    map.addSource('arcgis-otn-layer-2', {
                        type: 'geojson',
                        data: arcgisUrl2,
                        promoteId: 'OBJECTID'
                    });
                    map.addLayer({
                        id: 'arcgis-otn-lines-2',
                        type: 'line',
                        source: 'arcgis-otn-layer-2',
                        paint: {
                            'line-color': '#ff6600',
                            'line-width': 3,
                            'line-opacity': 0.8
                        }
                    }); // ä¸æŒ‡å®šbeforeIdï¼Œç¡®ä¿åœ°å›¾æ­£å¸¸åŠ è½½
                    
                    // å›¾å±‚3ï¼šçº¿å›¾å±‚
                    var arcgisUrl3 = 'http://192.168.70.216:6080/arcgis/rest/services/OTN/OTN/FeatureServer/3/query?where=1%3D1&outFields=*&f=geojson';
                    map.addSource('arcgis-otn-layer-3', {
                        type: 'geojson',
                        data: arcgisUrl3,
                        promoteId: 'OBJECTID'
                    });
                    map.addLayer({
                        id: 'arcgis-otn-lines-3',
                        type: 'line',
                        source: 'arcgis-otn-layer-3',
                        paint: {
                            'line-color': '#00cc66',
                            'line-width': 3,
                            'line-opacity': 0.7
                        }
                    }); // ä¸æŒ‡å®šbeforeIdï¼Œç¡®ä¿åœ°å›¾æ­£å¸¸åŠ è½½
                    
                    // ç„¶åæ·»åŠ ç‚¹å›¾å±‚ï¼ˆç½®äºçº¿å›¾å±‚ä¹‹ä¸Šï¼Œçƒ­åŠ›å›¾å’Œæ•…éšœç‚¹ä¹‹ä¸‹ï¼‰
                    // å›¾å±‚0ï¼šç‚¹å›¾å±‚
                    var arcgisUrl0 = 'http://192.168.70.216:6080/arcgis/rest/services/OTN/OTN/FeatureServer/0/query?where=1%3D1&outFields=*&f=geojson';
                    map.addSource('arcgis-otn-layer-0', {
                        type: 'geojson',
                        data: arcgisUrl0,
                        promoteId: 'OBJECTID'
                    });
                    map.addLayer({
                        id: 'arcgis-otn-points-0',
                        type: 'circle',
                        source: 'arcgis-otn-layer-0',
                        paint: {
                            'circle-radius': [
                                'interpolate', ['linear'], ['zoom'],
                                6, 4,    // ç¼©æ”¾çº§åˆ«6æ—¶ï¼ŒåŠå¾„ä¸º4
                                10, 8,   // ç¼©æ”¾çº§åˆ«10æ—¶ï¼ŒåŠå¾„ä¸º8
                                15, 12   // ç¼©æ”¾çº§åˆ«15æ—¶ï¼ŒåŠå¾„ä¸º12
                            ],
                            'circle-color': '#007bff',
                            'circle-stroke-width': 2,
                            'circle-stroke-color': '#ffffff',
                            'circle-opacity': 0.9,
                            'circle-stroke-opacity': 0.8
                        }
                    }); // ä¸æŒ‡å®šbeforeIdï¼Œé»˜è®¤æ·»åŠ åœ¨ç°æœ‰å›¾å±‚ä¹‹ä¸Š
                    
                    // ä¸ºç‚¹å›¾å±‚0æ·»åŠ æ–‡æœ¬æ ‡æ³¨ï¼ˆä½¿ç”¨O_nameå­—æ®µï¼Œå¢å¼ºå…¼å®¹æ€§ï¼‰
                    map.addLayer({
                        id: 'arcgis-otn-labels-0',
                        type: 'symbol',
                        source: 'arcgis-otn-layer-0',
                        layout: {
                            'text-field': [
                                'coalesce',
                                ['get', 'O_name'],
                                ['get', 'O_NAME'],
                                ['get', 'o_name'],
                                ['get', 'name'],
                                ''  // é»˜è®¤å€¼
                            ],
                            'text-font': ['Arial Unicode MS Bold', 'sans-serif'],
                            'text-size': 14,
                            'text-offset': [0, -1.5],
                            'text-anchor': 'bottom',
                            'text-allow-overlap': false,
                            'text-ignore-placement': false
                        },
                        paint: {
                            'text-color': '#ffffff',
                            'text-halo-color': 'rgba(0, 0, 0, 0.8)',
                            'text-halo-width': 2
                        }
                    });
                    
                    // å›¾å±‚1ï¼šç‚¹å›¾å±‚
                    var arcgisUrl1 = 'http://192.168.70.216:6080/arcgis/rest/services/OTN/OTN/FeatureServer/1/query?where=1%3D1&outFields=*&f=geojson';
                    map.addSource('arcgis-otn-layer-1', {
                        type: 'geojson',
                        data: arcgisUrl1,
                        promoteId: 'OBJECTID'
                    });
                    map.addLayer({
                        id: 'arcgis-otn-points-1',
                        type: 'circle',
                        source: 'arcgis-otn-layer-1',
                        paint: {
                            'circle-radius': [
                                'interpolate', ['linear'], ['zoom'],
                                6, 3,    // ç¼©æ”¾çº§åˆ«6æ—¶ï¼ŒåŠå¾„ä¸º3
                                10, 6,   // ç¼©æ”¾çº§åˆ«10æ—¶ï¼ŒåŠå¾„ä¸º6
                                15, 10   // ç¼©æ”¾çº§åˆ«15æ—¶ï¼ŒåŠå¾„ä¸º10
                            ],
                            'circle-color': '#00aaff',
                            'circle-stroke-width': 1,
                            'circle-stroke-color': '#ffffff',
                            'circle-opacity': 0.8,
                            'circle-stroke-opacity': 0.7
                        }
                    }); // ä¸æŒ‡å®šbeforeIdï¼Œé»˜è®¤æ·»åŠ åœ¨ç°æœ‰å›¾å±‚ä¹‹ä¸Š
                    
                    // ä¸ºç‚¹å›¾å±‚1æ·»åŠ æ–‡æœ¬æ ‡æ³¨ï¼ˆä½¿ç”¨O_nameå­—æ®µï¼Œå¢å¼ºå…¼å®¹æ€§ï¼‰
                    map.addLayer({
                        id: 'arcgis-otn-labels-1',
                        type: 'symbol',
                        source: 'arcgis-otn-layer-1',
                        layout: {
                            'text-field': [
                                'coalesce',
                                ['get', 'O_name'],
                                ['get', 'O_NAME'],
                                ['get', 'o_name'],
                                ['get', 'name'],
                                ''  // é»˜è®¤å€¼
                            ],
                            'text-font': ['Arial Unicode MS Bold', 'sans-serif'],
                            'text-size': 13,
                            'text-offset': [0, -1.5],
                            'text-anchor': 'bottom',
                            'text-allow-overlap': false,
                            'text-ignore-placement': false
                        },
                        paint: {
                            'text-color': '#ffffff',
                            'text-halo-color': 'rgba(0, 0, 0, 0.8)',
                            'text-halo-width': 2
                        }
                    });
                    
                    // ç°åœ¨æ·»åŠ çƒ­åŠ›å›¾ï¼Œç½®äºArcGISçº¿å›¾å±‚ä¹‹ä¸Š
                    if (features.length > 0) {
                        map.addSource('faults', {
                            type: 'geojson',
                            data: {
                                type: 'FeatureCollection',
                                features: features
                            }
                        });

                        map.addLayer({
                            id: 'faults-heat',
                            type: 'heatmap',
                            source: 'faults',
                            maxzoom: 15,
                            paint: {
                                // æ ¹æ®é¢‘ç‡å’Œå±æ€§å¤§å°å¢åŠ çƒ­åŠ›å›¾æƒé‡ - é™ä½é˜ˆå€¼ä½¿çƒ­ç‚¹æ›´æ˜æ˜¾
                                'heatmap-weight': [
                                    'interpolate',
                                    ['linear'],
                                    ['get', 'count'],
                                    0, 0,
                                    4, 1  // å°†é˜ˆå€¼ä»10é™ä½åˆ°4ï¼Œå¢åŠ ä½å¯†åº¦åŒºåŸŸæ˜¾ç¤º
                                ],
                                // æ ¹æ®ç¼©æ”¾çº§åˆ«å¢åŠ çƒ­åŠ›å›¾é¢œè‰²æƒé‡ - é€‚åº¦å¢å¼ºå¯¹æ¯”åº¦
                                // heatmap-intensityæ˜¯heatmap-weightçš„ä¹˜æ•°
                                'heatmap-intensity': [
                                    'interpolate',
                                    ['linear'],
                                    ['zoom'],
                                    0, 1,
                                    9, 4  // å°†å¼ºåº¦ä»5è°ƒæ•´åˆ°4ï¼Œé€‚åº¦å¢å¼ºå¯¹æ¯”åº¦
                                ],
                                // çƒ­åŠ›å›¾é¢œè‰²æ¸å˜ã€‚åŸŸä¸º0ï¼ˆä½ï¼‰åˆ°1ï¼ˆé«˜ï¼‰ã€‚ 
                                // ä»0-stopå¼€å§‹ä½¿ç”¨0é€æ˜åº¦çš„é¢œè‰²åˆ›å»ºæ¨¡ç³Šæ•ˆæœã€‚
                                'heatmap-color': [
                                    'interpolate',
                                    ['linear'],
                                    ['heatmap-density'],
                                    0, 'rgba(33,102,172,0)',
                                    0.1, 'rgb(103,169,207)',  // æ¢å¤ä½å¯†åº¦åŒºåŸŸçš„é¢œè‰²
                                    0.3, 'rgb(209,229,240)',
                                    0.5, 'rgb(253,219,199)',
                                    0.7, 'rgb(239,138,98)',
                                    1, 'rgb(178,24,43)'  // æ¢å¤æ ‡å‡†é«˜å¯†åº¦é¢œè‰²
                                ],
                                // æ ¹æ®ç¼©æ”¾çº§åˆ«è°ƒæ•´çƒ­åŠ›å›¾åŠå¾„ - å¢åŠ åŠå¾„ä½¿çƒ­ç‚¹æ›´æ˜æ˜¾
                                'heatmap-radius': [
                                    'interpolate',
                                    ['linear'],
                                    ['zoom'],
                                    0, 3,   // å°†æœ€å°åŠå¾„ä»1å¢åŠ åˆ°3
                                    9, 25   // å°†æœ€å¤§åŠå¾„ä»10å¢åŠ åˆ°25ï¼Œä½¿çƒ­ç‚¹æ›´æ˜æ˜¾
                                ],
                                // æ ¹æ®ç¼©æ”¾çº§åˆ«ä»çƒ­åŠ›å›¾è¿‡æ¸¡åˆ°åœ†å½¢å›¾å±‚
                                'heatmap-opacity': [
                                    'interpolate',
                                    ['linear'],
                                    ['zoom'],
                                    7, 1,
                                    9, 0
                                ],
                            }
                        });
                    }
                    
                    // ä¸ºæ‰€æœ‰ç‚¹å›¾å±‚æ·»åŠ hoveræ•ˆæœ
                    ['arcgis-otn-points-0', 'arcgis-otn-points-1'].forEach(function(layerId) {
                        var hoveredStateId = null;
                        var sourceId = layerId.replace('-points-', '-layer-');
                        
                        map.on('mouseenter', layerId, function(e) {
                            map.getCanvas().style.cursor = 'pointer';
                            
                            if (e.features.length > 0) {
                                if (hoveredStateId !== null) {
                                    map.setFeatureState(
                                        { source: sourceId, id: hoveredStateId },
                                        { hover: false }
                                    );
                                }
                                hoveredStateId = e.features[0].id;
                                map.setFeatureState(
                                    { source: sourceId, id: hoveredStateId },
                                    { hover: true }
                                );
                            }
                        });
                        
                        map.on('mouseleave', layerId, function() {
                            map.getCanvas().style.cursor = '';
                            if (hoveredStateId !== null) {
                                map.setFeatureState(
                                    { source: sourceId, id: hoveredStateId },
                                    { hover: false }
                                );
                            }
                            hoveredStateId = null;
                        });
                        
                        // ç‚¹å‡»æ˜¾ç¤ºå¼¹å‡ºä¿¡æ¯
                        map.on('click', layerId, function(e) {
                            if (e.features.length > 0) {
                                var feature = e.features[0];
                                var properties = feature.properties;
                                
                                // æ„å»ºå¼¹å‡ºå†…å®¹
                                var popupContent = '<div style="max-width: 300px;">';
                                popupContent += '<h6>OTNç½‘ç»œèŠ‚ç‚¹</h6>';
                                popupContent += '<table class="table table-sm">';
                                
                                // æ˜¾ç¤ºæ‰€æœ‰å±æ€§
                                for (var key in properties) {
                                    if (properties.hasOwnProperty(key) && properties[key] !== null) {
                                        popupContent += '<tr>';
                                        popupContent += '<th style="width: 40%;">' + key + '</th>';
                                        popupContent += '<td>' + properties[key] + '</td>';
                                        popupContent += '</tr>';
                                    }
                                }
                                
                                popupContent += '</table>';
                                popupContent += '</div>';
                                
                                new maplibregl.Popup()
                                    .setLngLat(e.lngLat)
                                    .setHTML(popupContent)
                                    .addTo(map);
                            }
                        });
                    });
                    
                    // ä¸ºçº¿å›¾å±‚æ·»åŠ hoveræ•ˆæœ
                    ['arcgis-otn-lines-2', 'arcgis-otn-lines-3'].forEach(function(layerId) {
                        map.on('mouseenter', layerId, function() {
                            map.getCanvas().style.cursor = 'pointer';
                        });
                        
                        map.on('mouseleave', layerId, function() {
                            map.getCanvas().style.cursor = '';
                        });
                        
                        // ç‚¹å‡»æ˜¾ç¤ºå¼¹å‡ºä¿¡æ¯
                        map.on('click', layerId, function(e) {
                            if (e.features.length > 0) {
                                var feature = e.features[0];
                                var properties = feature.properties;
                                
                                // æ„å»ºå¼¹å‡ºå†…å®¹
                                var popupContent = '<div style="max-width: 300px;">';
                                popupContent += '<h6>OTNç½‘ç»œçº¿è·¯</h6>';
                                popupContent += '<table class="table table-sm">';
                                
                                // æ˜¾ç¤ºæ‰€æœ‰å±æ€§
                                for (var key in properties) {
                                    if (properties.hasOwnProperty(key) && properties[key] !== null) {
                                        popupContent += '<tr>';
                                        popupContent += '<th style="width: 40%;">' + key + '</th>';
                                        popupContent += '<td>' + properties[key] + '</td>';
                                        popupContent += '</tr>';
                                    }
                                }
                                
                                popupContent += '</table>';
                                popupContent += '</div>';
                                
                                new maplibregl.Popup()
                                    .setLngLat(e.lngLat)
                                    .setHTML(popupContent)
                                    .addTo(map);
                            }
                        });
                    });
                    
                    console.log('ArcGIS OTNå›¾å±‚åŠ è½½æˆåŠŸï¼ˆ4ä¸ªå›¾å±‚ï¼‰');
                    
                    // æ·»åŠ ç¼©æ”¾äº‹ä»¶ç›‘å¬ï¼ŒåŠ¨æ€æ§åˆ¶å›¾å±‚æ˜¾ç¤º
                    map.on('zoom', function() {
                        if (layerToggleControl.arcgisVisible) {
                            layerToggleControl.updateArcgisLayersVisibility();
                        }
                    });
                    
                    // åˆå§‹è®¾ç½®å›¾å±‚å¯è§æ€§
                    layerToggleControl.updateArcgisLayersVisibility();
                    
                    // æ·»åŠ åœ°å›¾åŠ è½½å®Œæˆåçš„åˆå§‹çŠ¶æ€åŒæ­¥
                    map.once('idle', function() {
                        console.log('åœ°å›¾åŠ è½½å®Œæˆï¼ŒåŒæ­¥ArcGISæŒ‰é’®åˆå§‹çŠ¶æ€');
                        layerToggleControl.updateArcgisLayersVisibility();
                    });
                    
                } catch (error) {
                    console.warn('ArcGISå›¾å±‚åŠ è½½å¤±è´¥ï¼Œä½†ä¸å½±å“å…¶ä»–åŠŸèƒ½:', error);
                    // å¦‚æœArcGISå›¾å±‚åŠ è½½å¤±è´¥ï¼Œéšè—å¯¹åº”çš„å¼€å…³æŒ‰é’®
                    if (layerToggleControl.arcgisButton) {
                        layerToggleControl.arcgisButton.style.display = 'none';
                    }
                }
                
                // åˆ›å»ºæ•…éšœç‚¹å›¾ä¾‹
                function createFaultLegend() {
                    var legendContainer = document.createElement('div');
                    legendContainer.className = 'maplibregl-ctrl maplibregl-ctrl-group fault-legend';
                    legendContainer.style.padding = '10px';
                    legendContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
                    legendContainer.style.borderRadius = '4px';
                    legendContainer.style.boxShadow = '0 0 10px rgba(0,0,0,0.1)';
                    legendContainer.style.maxWidth = '200px';
                    
                    var legendTitle = document.createElement('div');
                    legendTitle.innerHTML = '<strong>æ•…éšœåˆ†ç±»å›¾ä¾‹</strong>';
                    legendTitle.style.marginBottom = '8px';
                    legendTitle.style.borderBottom = '1px solid #ddd';
                    legendTitle.style.paddingBottom = '5px';
                    legendContainer.appendChild(legendTitle);
                    
                    // æ·»åŠ æ¯ä¸ªåˆ†ç±»çš„å›¾ä¾‹é¡¹
                    Object.keys(faultCategoryColors).forEach(function(category) {
                        var legendItem = document.createElement('div');
                        legendItem.style.display = 'flex';
                        legendItem.style.alignItems = 'center';
                        legendItem.style.marginBottom = '5px';
                        
                        var colorBox = document.createElement('div');
                        colorBox.style.width = '15px';
                        colorBox.style.height = '15px';
                        colorBox.style.backgroundColor = faultCategoryColors[category];
                        colorBox.style.borderRadius = '3px';
                        colorBox.style.marginRight = '8px';
                        colorBox.style.border = '1px solid #ccc';
                        
                        var label = document.createElement('span');
                        label.style.fontSize = '12px';
                        label.textContent = faultCategoryNames[category];
                        
                        legendItem.appendChild(colorBox);
                        legendItem.appendChild(label);
                        legendContainer.appendChild(legendItem);
                    });
                    
                    return legendContainer;
                }
                
                // æ·»åŠ å›¾ä¾‹åˆ°åœ°å›¾å³ä¸‹è§’
                var legendControl = {
                    onAdd: function(map) {
                        this.container = createFaultLegend();
                        return this.container;
                    },
                    onRemove: function() {
                        this.container.parentNode.removeChild(this.container);
                        this.map = undefined;
                    }
                };
                
                map.addControl(legendControl, 'bottom-right');
                
                // éšè—åŠ è½½çŠ¶æ€
                loadingOverlay.classList.add('hidden');
            });

            map.on('error', function (e) {
                console.error('åœ°å›¾åŠ è½½é”™è¯¯:', e.error);
                showMapError('åœ°å›¾åŠ è½½å¤±è´¥: ' + (e.error.message || 'æœªçŸ¥é”™è¯¯'));
            });

        } catch (error) {
            console.error('åœ°å›¾åˆå§‹åŒ–é”™è¯¯:', error);
            showMapError('åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ' + error.message);
        }

        function showMapError(message) {
            // ç§»é™¤åŠ è½½è¦†ç›–å±‚
            if (loadingOverlay && loadingOverlay.parentNode) {
                loadingOverlay.parentNode.removeChild(loadingOverlay);
            }
            
            // åˆ›å»ºé”™è¯¯è¦†ç›–å±‚
            var errorOverlay = document.createElement('div');
            errorOverlay.className = 'map-overlay map-error';
            errorOverlay.innerHTML = `
                <h5>åœ°å›¾åŠ è½½å¤±è´¥</h5>
                <p>${message}</p>
                <ul>
                    <li>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</li>
                    <li>ç¡®ä¿APIå¯†é’¥æœ‰æ•ˆ</li>
                    <li>åˆ·æ–°é¡µé¢é‡è¯•</li>
                    <li>å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·è”ç³»ç®¡ç†å‘˜</li>
                </ul>
                <button class="btn btn-primary mt-3" onclick="window.location.reload()">
                    åˆ·æ–°é¡µé¢
                </button>
            `;
            mapContainer.appendChild(errorOverlay);
        }
    });
</script>
{% endblock %}
