{% extends 'base/layout.html' %}
{% load static %}

{% block title %}故障分布图{% endblock %}

{% block content %}
<div class="row mb-3">
  <div class="col">
    <div class="card">
      <h5 class="card-header">
        故障分布图
        <div class="card-actions">
          <a
            href="{% url 'plugins:netbox_otnfaults:otnfault_list' %}"
            class="btn btn-ghost-primary btn-sm"
          >
            <i class="mdi mdi-format-list-bulleted"></i> 查看列表
          </a>
        </div>
      </h5>
      <div class="card-body p-0">
        <div id="map" style="height: calc(-178px + 100vh); width: 100%"></div>
      </div>
    </div>
  </div>
</div>

<link
  href="{% static 'netbox_otnfaults/lib/maplibre-gl.css' %}"
  rel="stylesheet"
/>
<script src="{% static 'netbox_otnfaults/lib/maplibre-gl.js' %}"></script>
<script src="{% static 'netbox_otnfaults/lib/pmtiles.js' %}"></script>
<script src="https://unpkg.com/deck.gl@^9.0.0/dist.min.js"></script>

<link
  rel="stylesheet"
  href="{% static 'netbox_otnfaults/css/otnfault_map_globe.css' %}"
/>
<link
  rel="stylesheet"
  href="{% static 'netbox_otnfaults/css/otnfault_map_controls.css' %}"
/>

<script>
  window.OTNFaultMapConfig = {
      heatmapData: {{ heatmap_data| safe }},
      markerData: {{ marker_data| safe }},
      sitesData: {{ sites_data| safe }},
      apiKey: "{{ apikey }}",
      faultListUrl: "{% url 'plugins:netbox_otnfaults:otnfault_list' %}",
      mapCenter: {{ map_center| safe }},
      mapZoom: {{ map_zoom }},
      useLocalBasemap: {{ use_local_basemap|yesno:"true,false" }},
      localTilesUrl: "{{ local_tiles_url }}",
      localGlyphsUrl: "{{ local_glyphs_url }}",
      otnPathsPmtilesUrl: "{{ otn_paths_pmtiles_url }}",
      colorsConfig: {{ colors_config| safe }}
  };
</script>

<!-- Base -->
<script src="{% static 'netbox_otnfaults/js/maplibregl_base.js' %}"></script>

<!-- Core -->
<script src="{% static 'netbox_otnfaults/js/core/config.js' %}"></script>

<!-- Services -->
<script src="{% static 'netbox_otnfaults/js/services/FaultDataService.js' %}"></script>
<script src="{% static 'netbox_otnfaults/js/services/PopupTemplates.js' %}"></script>

<!-- Utils -->
<script src="{% static 'netbox_otnfaults/js/utils/api.js' %}"></script>

<!-- Controls -->
<script src="{% static 'netbox_otnfaults/js/controls/LayerToggleControl.js' %}"></script>
<script src="{% static 'netbox_otnfaults/js/controls/FaultStatisticsControl.js' %}"></script>
<script src="{% static 'netbox_otnfaults/js/controls/FaultLegendControl.js' %}"></script>
<script src="{% static 'netbox_otnfaults/js/controls/SearchControl.js' %}"></script>

<!-- App (Main) -->
<script src="{% static 'netbox_otnfaults/js/otnfault_map_app.js' %}?v=11"></script>
{% endblock %}
