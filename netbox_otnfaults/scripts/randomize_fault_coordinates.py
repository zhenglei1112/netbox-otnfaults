from extras.scripts import Script, ObjectVar
from netbox_otnfaults.models import OtnFault
import random

class RandomizeFaultCoordinates(Script):
    class Meta:
        name = "随机化故障坐标 (Randomize Fault Coordinates)"
        description = "将所有故障模型的经纬度坐标设置为指定高速公路上的随机点。"
        commit_default = True

    def run(self, data, commit):
        # 高速公路大概坐标点 (城市/节点)
        # 格式: [(lat, lon), (lat, lon), ...]
        highways = {
            "G15 (沈海高速)": [
                (41.8057, 123.4315), # 沈阳
                (38.9140, 121.6147), # 大连
                (37.4638, 121.4479), # 烟台
                (36.0671, 120.3826), # 青岛
                (35.2975, 119.3368), # 日照
                (34.5967, 119.2214), # 连云港
                (33.3472, 120.1636), # 盐城
                (31.9802, 120.8943), # 南通
                (31.2304, 121.4737), # 上海
                (29.8683, 121.5440), # 宁波
                (28.0053, 120.6994), # 温州
                (26.0745, 119.2965), # 福州
                (24.4798, 118.0894), # 厦门
                (23.3668, 116.6820), # 汕头
                (22.5431, 114.0579), # 深圳
                (23.1291, 113.2644), # 广州
                (21.1965, 110.4045), # 湛江
                (20.0174, 110.3492), # 海口
            ],
            "G2 (京沪高速)": [
                (39.9042, 116.4074), # 北京
                (39.0842, 117.2009), # 天津
                (36.6512, 117.1201), # 济南
                (34.2044, 117.2857), # 徐州
                (32.3946, 119.4124), # 扬州
                (31.2304, 121.4737), # 上海
            ],
            "G4 (京港澳高速)": [
                (39.9042, 116.4074), # 北京
                (38.0423, 114.5149), # 石家庄
                (34.7466, 113.6253), # 郑州
                (30.5928, 114.3055), # 武汉
                (28.2282, 112.9388), # 长沙
                (23.1291, 113.2644), # 广州
                (22.5431, 114.0579), # 深圳
            ],
            "G5 (京昆高速)": [
                (39.9042, 116.4074), # 北京
                (37.8706, 112.5489), # 太原
                (34.3416, 108.9398), # 西安
                (30.6586, 104.0648), # 成都
                (25.0453, 102.7097), # 昆明
            ],
            "G65 (包茂高速)": [
                (40.6575, 109.8404), # 包头
                (38.2856, 109.7303), # 榆林
                (34.3416, 108.9398), # 西安
                (29.5630, 106.5516), # 重庆
                (26.6470, 106.6302), # 贵阳
                (22.8170, 108.3665), # 南宁
                (21.6628, 110.9258), # 茂名
            ],
            "G20 (青银高速)": [
                (36.0671, 120.3826), # 青岛
                (36.6512, 117.1201), # 济南
                (38.0423, 114.5149), # 石家庄
                (37.8706, 112.5489), # 太原
                (38.4872, 106.2309), # 银川
            ],
            "G30 (连霍高速)": [
                (34.5967, 119.2214), # 连云港
                (34.7466, 113.6253), # 郑州
                (34.3416, 108.9398), # 西安
                (36.0611, 103.8343), # 兰州
                (43.8256, 87.6168),  # 乌鲁木齐
                (44.1685, 80.5286),  # 霍尔果斯
            ],
            "G42 (沪蓉高速)": [
                (31.2304, 121.4737), # 上海
                (32.0603, 118.7969), # 南京
                (31.8206, 117.2272), # 合肥
                (30.5928, 114.3055), # 武汉
                (30.6586, 104.0648), # 成都
            ],
            "G60 (沪昆高速)": [
                (31.2304, 121.4737), # 上海
                (30.2741, 120.1551), # 杭州
                (28.6829, 115.8582), # 南昌
                (28.2282, 112.9388), # 长沙
                (26.6470, 106.6302), # 贵阳
                (25.0453, 102.7097), # 昆明
            ],
            "G80 (广昆高速)": [
                (23.1291, 113.2644), # 广州
                (22.8170, 108.3665), # 南宁
                (25.0453, 102.7097), # 昆明
            ]
        }
        
        # 获取所有故障对象
        faults = OtnFault.objects.all()
        highway_names = list(highways.keys())
        
        self.log_info(f"开始更新 {faults.count()} 个故障对象的坐标...")

        for fault in faults:
            # 1. 随机选择一条高速
            highway_name = random.choice(highway_names)
            route_points = highways[highway_name]
            
            # 2. 随机选择该高速上的一个段 (两个点之间)
            # 确保至少有2个点
            if len(route_points) < 2:
                continue
                
            segment_index = random.randint(0, len(route_points) - 2)
            pt1 = route_points[segment_index]
            pt2 = route_points[segment_index + 1]
            
            # 3. 在该段上进行线性插值，加上一点随机偏移
            t = random.random() # 0 到 1 之间的随机比例
            
            # 简单的线性插值
            lat = pt1[0] + (pt2[0] - pt1[0]) * t
            lon = pt1[1] + (pt2[1] - pt1[1]) * t
            
            # 添加微小的随机偏移 (模拟在路附近但不完全在直线上)
            # 大约 0.01 度 约等于 1公里
            lat += random.uniform(-0.02, 0.02)
            lon += random.uniform(-0.02, 0.02)
            
            # 4. 更新对象
            fault.interruption_latitude = lat
            fault.interruption_longitude = lon
            
            # 如果你想把高速名字也记录下来，可以考虑放在 details 里，但这里主要还是改坐标
            # fault.fault_details = f"{fault.fault_details or ''}\n\n[脚本更新] 坐标位于 {highway_name}"
            
            fault.save()
            self.log_success(f"故障 {fault.fault_number} 坐标已更新至 {highway_name} 附近 ({lat:.6f}, {lon:.6f})")

        self.log_info("处理完成。")
